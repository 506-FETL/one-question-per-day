name: å‘å¸ƒåå¤„ç†

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  post-release:
    # ä»…åœ¨PRè¢«åˆå¹¶ä¸”PRæ ‡é¢˜åŒ…å«"Release"æ—¶è¿è¡Œ
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.title, 'Release')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main # æ˜ç¡® checkout åˆ° main åˆ†æ”¯

      - name: æå–ç‰ˆæœ¬å·
        id: extract-version
        run: |
          # ä» main åˆ†æ”¯ä¸Šçš„ package.json æå–ç‰ˆæœ¬å·
          VERSION=$(node -p "require('./package.json').version")
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ä» main åˆ†æ”¯æå–åˆ°ç‰ˆæœ¬å·: v$VERSION"
          echo "ğŸ“ å½“å‰ commit: $(git rev-parse HEAD)"

      - name: æ£€æŸ¥ Tag æ˜¯å¦å­˜åœ¨
        id: check-tag
        run: |
          TAG_NAME="${{ steps.extract-version.outputs.version }}"

          # æ£€æŸ¥è¿œç¨‹æ˜¯å¦æœ‰è¿™ä¸ª tag
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "tag-exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Tag $TAG_NAME å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            echo "tag-exists=false" >> $GITHUB_OUTPUT
            echo "ğŸ†• Tag $TAG_NAME ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º"
          fi

      - name: åˆ›å»º Git Tag
        if: steps.check-tag.outputs.tag-exists == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # è·å–å½“å‰ main åˆ†æ”¯çš„ HEAD commit
          CURRENT_COMMIT=$(git rev-parse HEAD)
          TAG_NAME="${{ steps.extract-version.outputs.version }}"

          echo "ğŸ·ï¸ åˆ›å»º tag $TAG_NAME æŒ‡å‘ commit $CURRENT_COMMIT"

          # åˆ›å»º tag
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"

          echo "âœ… Git Tag $TAG_NAME åˆ›å»ºæˆåŠŸ"

      - name: åˆ›å»º GitHub Release
        if: steps.check-tag.outputs.tag-exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract-version.outputs.version }}
          name: 'ï¿½ ${{ steps.extract-version.outputs.version }} - 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜'
          body: |
            # ğŸ“š 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ Release ${{ steps.extract-version.outputs.version }}

            ## ğŸ¯ æœ¬æ¬¡å‘å¸ƒ

            è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–å‘å¸ƒï¼ŒåŒ…å«äº†æœ€æ–°çš„ä»£ç æ›´æ–°å’Œæ”¹è¿›ã€‚

            ## ğŸ“Š é¡¹ç›®ç»Ÿè®¡

            - ğŸ“š æ€»é¢˜ç›®æ•°é‡: æŒç»­å¢é•¿ä¸­
            - ğŸ‘¥ æ´»è·ƒè´¡çŒ®è€…: å¤šä½å¼€å‘è€…å‚ä¸
            - ğŸ› ï¸ æŠ€æœ¯æ ˆ: JavaScript, TypeScript, Vite, Vitest

            ## ğŸš€ å¿«é€Ÿå¼€å§‹

            ```bash
            # å…‹éš†é¡¹ç›®
            git clone https://github.com/506-FETL/one-question-per-day.git

            # å®‰è£…ä¾èµ–
            pnpm install

            # è¿è¡Œæµ‹è¯•
            pnpm test

            # å¼€å‘æ¨¡å¼
            pnpm dev
            ```

            ## ğŸ¤ å‚ä¸è´¡çŒ®

            æ¬¢è¿æŸ¥çœ‹ [README.md](https://github.com/506-FETL/one-question-per-day/blob/main/README.md) äº†è§£å¦‚ä½•å‚ä¸è´¡çŒ®ï¼

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        if: steps.check-tag.outputs.tag-exists == 'false'
        run: |
          echo "ğŸ‰ å‘å¸ƒå®Œæˆ!"
          echo "ğŸ“š é¡¹ç›®: 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ steps.extract-version.outputs.version }}"
          echo "ï¿½ Commit: $(git rev-parse HEAD)"
          echo "âœ¨ GitHub Release å·²åˆ›å»ºå®Œæˆ"

      - name: è·³è¿‡å‘å¸ƒé€šçŸ¥
        if: steps.check-tag.outputs.tag-exists == 'true'
        run: |
          echo "â„¹ï¸ Tag ${{ steps.extract-version.outputs.version }} å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
          echo "ğŸ“š é¡¹ç›®: 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜"
          echo "ğŸ“ å½“å‰ Commit: $(git rev-parse HEAD)"
