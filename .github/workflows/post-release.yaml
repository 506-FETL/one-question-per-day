name: å‘å¸ƒåå¤„ç†

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  post-release:
    # ä»…åœ¨PRè¢«åˆå¹¶ä¸”PRæ ‡é¢˜åŒ…å«"Release"æ—¶è¿è¡Œ
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.title, 'Release')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æå–ç‰ˆæœ¬å·
        id: extract-version
        run: |
          # ä»package.jsonæå–ç‰ˆæœ¬å·
          VERSION=$(node -p "require('./package.json').version")
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "æå–åˆ°ç‰ˆæœ¬å·: v$VERSION"

      - name: ç»Ÿè®¡é¡¹ç›®ä¿¡æ¯
        id: stats
        run: |
          # ç»Ÿè®¡é¢˜ç›®æ•°é‡
          TOTAL_DAYS=$(find problems/days -type d -name "Day *" | wc -l | tr -d ' ')
          echo "total-days=$TOTAL_DAYS" >> $GITHUB_OUTPUT

          # ç»Ÿè®¡è´¡çŒ®è€…
          CONTRIBUTORS=$(git shortlog -sn --all | wc -l | tr -d ' ')
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆ Release Notes
        id: release-notes
        run: |
          # è·å–æœ€æ–°çš„æ›´æ–°æ–‡æ¡£
          LATEST_UPDATE=$(find updates -name "*.md" -not -name "README.md" | sort -r | head -1)

          # å¼€å§‹æ„å»º Release Notes
          cat > release-notes.md << 'EOF'
          # ğŸ“š 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ Release

          ## ğŸ¯ æœ¬æ¬¡æ›´æ–°æ¦‚è§ˆ

          EOF

          # å¦‚æœæœ‰æ›´æ–°æ–‡æ¡£ï¼ŒåŒ…å«å…¶å†…å®¹
          if [ -f "$LATEST_UPDATE" ]; then
            echo "ä» $LATEST_UPDATE ç”Ÿæˆ Release Notes..."
            echo "" >> release-notes.md
            echo "## ğŸ“ è¯¦ç»†æ›´æ–°å†…å®¹" >> release-notes.md
            echo "" >> release-notes.md
            cat "$LATEST_UPDATE" >> release-notes.md
            echo "" >> release-notes.md
          fi

          # æ·»åŠ é¡¹ç›®ç»Ÿè®¡
          echo "## ğŸ“Š é¡¹ç›®ç»Ÿè®¡" >> release-notes.md
          echo "" >> release-notes.md
          echo "- ğŸ“š æ€»é¢˜ç›®æ•°é‡: **${{ steps.stats.outputs.total-days }}** å¤©" >> release-notes.md
          echo "- ğŸ‘¥ è´¡çŒ®è€…æ•°é‡: **${{ steps.stats.outputs.contributors }}** äºº" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ æŠ€æœ¯æ ˆä¿¡æ¯
          echo "## ğŸ› ï¸ æŠ€æœ¯æ ˆ" >> release-notes.md
          echo "" >> release-notes.md
          echo "- **è¯­è¨€**: JavaScript, TypeScript" >> release-notes.md
          echo "- **æµ‹è¯•**: Vitest" >> release-notes.md
          echo "- **ä»£ç è´¨é‡**: ESLint, Prettier" >> release-notes.md
          echo "- **åŒ…ç®¡ç†**: pnpm" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ ä½¿ç”¨è¯´æ˜
          echo "## ğŸš€ å¿«é€Ÿå¼€å§‹" >> release-notes.md
          echo "" >> release-notes.md
          echo "\`\`\`bash" >> release-notes.md
          echo "# å…‹éš†é¡¹ç›®" >> release-notes.md
          echo "git clone https://github.com/506-FETL/one-question-per-day.git" >> release-notes.md
          echo "" >> release-notes.md
          echo "# å®‰è£…ä¾èµ–" >> release-notes.md
          echo "pnpm install" >> release-notes.md
          echo "" >> release-notes.md
          echo "# è¿è¡Œæµ‹è¯•" >> release-notes.md
          echo "pnpm test" >> release-notes.md
          echo "" >> release-notes.md
          echo "# å¼€å‘æ¨¡å¼ï¼ˆåŒ…å«ä»£ç æ£€æŸ¥ã€æ ¼å¼åŒ–ã€æµ‹è¯•ï¼‰" >> release-notes.md
          echo "pnpm dev" >> release-notes.md
          echo "\`\`\`" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ è´¡çŒ®æŒ‡å—é“¾æ¥
          echo "## ğŸ¤ å‚ä¸è´¡çŒ®" >> release-notes.md
          echo "" >> release-notes.md
          echo "æ¬¢è¿åŠ å…¥506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ï¼è¯·æŸ¥çœ‹ [README.md](https://github.com/506-FETL/one-question-per-day/blob/main/README.md) äº†è§£è¯¦ç»†çš„å‚ä¸æŒ‡å—ã€‚" >> release-notes.md
          echo "" >> release-notes.md

          # è¾“å‡ºåˆ°å˜é‡
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥ Tag æ˜¯å¦å­˜åœ¨
        id: check-tag
        run: |
          if git rev-parse "${{ steps.extract-version.outputs.version }}" >/dev/null 2>&1; then
            echo "tag-exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag ${{ steps.extract-version.outputs.version }} å·²å­˜åœ¨"
          else
            echo "tag-exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag ${{ steps.extract-version.outputs.version }} ä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ›å»º"
          fi

      - name: åˆ›å»º Git Tag
        if: steps.check-tag.outputs.tag-exists == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a ${{ steps.extract-version.outputs.version }} -m "Release ${{ steps.extract-version.outputs.version }}"
          git push origin ${{ steps.extract-version.outputs.version }}
          echo "ğŸ·ï¸ Git Tag ${{ steps.extract-version.outputs.version }} åˆ›å»ºæˆåŠŸ"

      - name: åˆ›å»º GitHub Release
        if: steps.check-tag.outputs.tag-exists == 'false'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract-version.outputs.version }}
          release_name: 'ğŸ“š ${{ steps.extract-version.outputs.version }} - 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜'
          body: ${{ steps.release-notes.outputs.RELEASE_NOTES }}
          draft: false
          prerelease: false

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        if: steps.check-tag.outputs.tag-exists == 'false'
        run: |
          echo "âœ… å‘å¸ƒå®Œæˆ!"
          echo "ğŸ“š é¡¹ç›®: 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ steps.extract-version.outputs.version }}"
          echo "ğŸ“Š æ€»é¢˜ç›®æ•°: ${{ steps.stats.outputs.total-days }} å¤©"
          echo "ğŸ‘¥ è´¡çŒ®è€…: ${{ steps.stats.outputs.contributors }} äºº"
          echo "ğŸ‰ GitHub Release å·²åˆ›å»ºå®Œæˆ"

      - name: è·³è¿‡å‘å¸ƒé€šçŸ¥
        if: steps.check-tag.outputs.tag-exists == 'true'
        run: |
          echo "â„¹ï¸ Tag ${{ steps.extract-version.outputs.version }} å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
          echo "ğŸ“š é¡¹ç›®: 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜"
          echo "ğŸ·ï¸ ç°æœ‰ç‰ˆæœ¬: ${{ steps.extract-version.outputs.version }}"
