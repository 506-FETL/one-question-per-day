name: å‘å¸ƒåå¤„ç†

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  post-release:
    # ä»…åœ¨PRè¢«åˆå¹¶ä¸”PRæ ‡é¢˜åŒ…å«"Release"æ—¶è¿è¡Œ
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.title, 'Release')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main # æ˜ç¡® checkout åˆ° main åˆ†æ”¯

      - name: ç¡®ä¿åœ¨æœ€æ–°çš„ main åˆ†æ”¯ä¸Š
        run: |
          git checkout main
          git pull origin main
          echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          echo "å½“å‰ commit: $(git rev-parse HEAD)"
          echo "æœ€æ–° commit ä¿¡æ¯: $(git log -1 --oneline)"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æå–ç‰ˆæœ¬å·
        id: extract-version
        run: |
          # ç¡®è®¤æˆ‘ä»¬åœ¨æ­£ç¡®çš„åˆ†æ”¯å’Œä½ç½®
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          echo "å½“å‰ commit: $(git rev-parse HEAD)"

          # ä»package.jsonæå–ç‰ˆæœ¬å·
          VERSION=$(node -p "require('./package.json').version")
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "æå–åˆ°ç‰ˆæœ¬å·: v$VERSION"

          # éªŒè¯ package.json çš„å†…å®¹
          echo "package.json ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯:"
          grep '"version"' package.json

      - name: æ„å»ºå‘å¸ƒåŒ…
        run: |
          echo "ğŸ—ï¸ æ„å»ºå‘å¸ƒåŒ…..."
          pnpm run build

      - name: æ£€æŸ¥æ„å»ºè¾“å‡º
        id: check-build
        run: |
          # æ£€æŸ¥ dist ç›®å½•
          if [ ! -d "dist" ]; then
            echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          # æŸ¥æ‰¾æ„å»ºæ–‡ä»¶
          TAR_FILE=$(find dist -name "*.tar.gz" | head -1)
          ZIP_FILE=$(find dist -name "*.zip" | head -1)
          RELEASE_NOTES=$(find dist -name "release-notes-*.md" | head -1)

          if [ -z "$TAR_FILE" ] || [ -z "$ZIP_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ„å»ºæ–‡ä»¶"
            exit 1
          fi

          echo "tar-file=$TAR_FILE" >> $GITHUB_OUTPUT
          echo "zip-file=$ZIP_FILE" >> $GITHUB_OUTPUT
          echo "release-notes-file=$RELEASE_NOTES" >> $GITHUB_OUTPUT

          echo "âœ… æ„å»ºæ–‡ä»¶æ£€æŸ¥å®Œæˆ"

      - name: ç”Ÿæˆ Release Notes
        id: release-notes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºç”Ÿæˆçš„ Release Notes
          RELEASE_NOTES_FILE="${{ steps.check-build.outputs.release-notes-file }}"

          if [ -n "$RELEASE_NOTES_FILE" ] && [ -f "$RELEASE_NOTES_FILE" ]; then
            echo "ğŸ“ ä½¿ç”¨æ„å»ºç”Ÿæˆçš„ Release Notes: $RELEASE_NOTES_FILE"
            
            # å°†æ„å»ºç”Ÿæˆçš„ Release Notes å¤åˆ¶åˆ°æ ‡å‡†ä½ç½®
            cp "$RELEASE_NOTES_FILE" final-release-notes.md
            echo "release-notes-file=final-release-notes.md" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æ„å»ºçš„ Release Notes ä¸å­˜åœ¨ï¼Œç”Ÿæˆé»˜è®¤ Release Notes"
            
            # ç»Ÿè®¡é¡¹ç›®ä¿¡æ¯ä½œä¸ºå¤‡ç”¨
            TOTAL_DAYS=$(find problems/days -type d -name "Day *" | wc -l | tr -d ' ')
            CONTRIBUTORS=$(git shortlog -sn --all | wc -l | tr -d ' ')
            
            # è·å–æœ€æ–°çš„æ›´æ–°æ–‡æ¡£
            LATEST_UPDATE=$(find updates -name "*.md" -not -name "README.md" | sort -r | head -1)

            # å¼€å§‹æ„å»º Release Notes
            cat > release-notes.md << 'EOF'
          # ğŸ“š 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ Release

          ## ğŸ¯ æœ¬æ¬¡æ›´æ–°æ¦‚è§ˆ

          EOF

            # å¦‚æœæœ‰æ›´æ–°æ–‡æ¡£ï¼ŒåŒ…å«å…¶å†…å®¹
            if [ -f "$LATEST_UPDATE" ]; then
              echo "ä» $LATEST_UPDATE ç”Ÿæˆ Release Notes..."
              echo "" >> release-notes.md
              echo "## ğŸ“ è¯¦ç»†æ›´æ–°å†…å®¹" >> release-notes.md
              echo "" >> release-notes.md
              cat "$LATEST_UPDATE" >> release-notes.md
              echo "" >> release-notes.md
            fi

            # æ·»åŠ é¡¹ç›®ç»Ÿè®¡
            echo "## ğŸ“Š é¡¹ç›®ç»Ÿè®¡" >> release-notes.md
            echo "" >> release-notes.md
            echo "- ğŸ“š æ€»é¢˜ç›®æ•°é‡: **$TOTAL_DAYS** é¢˜" >> release-notes.md
            echo "- ğŸ‘¥ è´¡çŒ®è€…æ•°é‡: **$CONTRIBUTORS** äºº" >> release-notes.md
            echo "" >> release-notes.md

            # æ·»åŠ æŠ€æœ¯æ ˆä¿¡æ¯
            echo "## ğŸ› ï¸ æŠ€æœ¯æ ˆ" >> release-notes.md
            echo "" >> release-notes.md
            echo "- **è¯­è¨€**: JavaScript, TypeScript" >> release-notes.md
            echo "- **æµ‹è¯•**: Vitest" >> release-notes.md
            echo "- **ä»£ç è´¨é‡**: ESLint, Prettier" >> release-notes.md
            echo "- **åŒ…ç®¡ç†**: pnpm" >> release-notes.md
            echo "- **æ„å»ºå·¥å…·**: Vite" >> release-notes.md
            echo "" >> release-notes.md

            # æ·»åŠ ä½¿ç”¨è¯´æ˜
            echo "## ğŸš€ å¿«é€Ÿå¼€å§‹" >> release-notes.md
            echo "" >> release-notes.md
            echo "\`\`\`bash" >> release-notes.md
            echo "# å…‹éš†é¡¹ç›®" >> release-notes.md
            echo "git clone https://github.com/506-FETL/one-question-per-day.git" >> release-notes.md
            echo "" >> release-notes.md
            echo "# å®‰è£…ä¾èµ–" >> release-notes.md
            echo "pnpm install" >> release-notes.md
            echo "" >> release-notes.md
            echo "# è¿è¡Œæµ‹è¯•" >> release-notes.md
            echo "pnpm test" >> release-notes.md
            echo "" >> release-notes.md
            echo "# å¼€å‘æ¨¡å¼ï¼ˆåŒ…å«ä»£ç æ£€æŸ¥ã€æ ¼å¼åŒ–ã€æµ‹è¯•ï¼‰" >> release-notes.md
            echo "pnpm dev" >> release-notes.md
            echo "" >> release-notes.md
            echo "# æ„å»ºå‘å¸ƒåŒ…" >> release-notes.md
            echo "pnpm build" >> release-notes.md
            echo "\`\`\`" >> release-notes.md
            echo "" >> release-notes.md

            # æ·»åŠ è´¡çŒ®æŒ‡å—é“¾æ¥
            echo "## ğŸ¤ å‚ä¸è´¡çŒ®" >> release-notes.md
            echo "" >> release-notes.md
            echo "æ¬¢è¿åŠ å…¥506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ï¼è¯·æŸ¥çœ‹ [README.md](https://github.com/506-FETL/one-question-per-day/blob/main/README.md) äº†è§£è¯¦ç»†çš„å‚ä¸æŒ‡å—ã€‚" >> release-notes.md
            echo "" >> release-notes.md

            # è®¾ç½®æ–‡ä»¶è¾“å‡ºè€Œä¸æ˜¯å¤šè¡Œå­—ç¬¦ä¸²
            echo "release-notes-file=release-notes.md" >> $GITHUB_OUTPUT
          fi

      - name: æ£€æŸ¥ Tag æ˜¯å¦å­˜åœ¨
        id: check-tag
        run: |
          if git rev-parse "${{ steps.extract-version.outputs.version }}" >/dev/null 2>&1; then
            echo "tag-exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag ${{ steps.extract-version.outputs.version }} å·²å­˜åœ¨"
          else
            echo "tag-exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag ${{ steps.extract-version.outputs.version }} ä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ›å»º"
          fi

      - name: åˆ›å»º Git Tag
        if: steps.check-tag.outputs.tag-exists == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # è·å–å½“å‰ HEAD commit SHA
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "å°†ä¸º commit $CURRENT_COMMIT åˆ›å»º tag ${{ steps.extract-version.outputs.version }}"

          # åˆ›å»º tag å¹¶æ˜ç¡®æŒ‡å®š commit
          git tag -a ${{ steps.extract-version.outputs.version }} $CURRENT_COMMIT -m "Release ${{ steps.extract-version.outputs.version }}"
          git push origin ${{ steps.extract-version.outputs.version }}
          echo "ğŸ·ï¸ Git Tag ${{ steps.extract-version.outputs.version }} åˆ›å»ºæˆåŠŸï¼ŒæŒ‡å‘ commit: $CURRENT_COMMIT"

      - name: åˆ›å»º GitHub Release
        if: steps.check-tag.outputs.tag-exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract-version.outputs.version }}
          name: 'ğŸ“š ${{ steps.extract-version.outputs.version }} - 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜'
          body_path: ${{ steps.release-notes.outputs.release-notes-file }}
          target_commitish: main # æ˜ç¡®æŒ‡å®šåŸºäº main åˆ†æ”¯åˆ›å»º release
          files: |
            ${{ steps.check-build.outputs.tar-file }}
            ${{ steps.check-build.outputs.zip-file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        if: steps.check-tag.outputs.tag-exists == 'false'
        run: |
          # ç»Ÿè®¡é¡¹ç›®ä¿¡æ¯ç”¨äºé€šçŸ¥
          TOTAL_DAYS=$(find problems/days -type d -name "Day *" | wc -l | tr -d ' ')
          CONTRIBUTORS=$(git shortlog -sn --all | wc -l | tr -d ' ')

          echo "âœ… å‘å¸ƒå®Œæˆ!"
          echo "ğŸ“š é¡¹ç›®: 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ steps.extract-version.outputs.version }}"
          echo "ğŸ“Š æ€»é¢˜ç›®æ•°: $TOTAL_DAYS é¢˜"
          echo "ğŸ‘¥ è´¡çŒ®è€…: $CONTRIBUTORS äºº"
          echo "ğŸ‰ GitHub Release å·²åˆ›å»ºå®Œæˆ"
          echo "ğŸ“¦ å‘å¸ƒåŒ…å·²ä¸Šä¼ åˆ° Release"

      - name: è·³è¿‡å‘å¸ƒé€šçŸ¥
        if: steps.check-tag.outputs.tag-exists == 'true'
        run: |
          echo "â„¹ï¸ Tag ${{ steps.extract-version.outputs.version }} å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
          echo "ğŸ“š é¡¹ç›®: 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜"
          echo "ğŸ·ï¸ ç°æœ‰ç‰ˆæœ¬: ${{ steps.extract-version.outputs.version }}"
