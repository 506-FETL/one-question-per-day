name: 发布后处理

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  post-release:
    # 仅在PR被合并且PR标题包含"Release"时运行
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.title, 'Release')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main # 明确 checkout 到 main 分支

      - name: 提取版本号
        id: extract-version
        run: |
          # 从 main 分支上的 package.json 提取版本号
          VERSION=$(node -p "require('./package.json').version")
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "✅ 从 main 分支提取到版本号: v$VERSION"
          echo "📍 当前 commit: $(git rev-parse HEAD)"

      - name: 检查 Tag 是否存在
        id: check-tag
        run: |
          TAG_NAME="${{ steps.extract-version.outputs.version }}"

          # 检查远程是否有这个 tag
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "tag-exists=true" >> $GITHUB_OUTPUT
            echo "✅ Tag $TAG_NAME 已存在，跳过创建"
          else
            echo "tag-exists=false" >> $GITHUB_OUTPUT
            echo "🆕 Tag $TAG_NAME 不存在，需要创建"
          fi

      - name: 创建 Git Tag
        if: steps.check-tag.outputs.tag-exists == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # 获取当前 main 分支的 HEAD commit
          CURRENT_COMMIT=$(git rev-parse HEAD)
          TAG_NAME="${{ steps.extract-version.outputs.version }}"

          echo "🏷️ 创建 tag $TAG_NAME 指向 commit $CURRENT_COMMIT"

          # 创建 tag
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"

          echo "✅ Git Tag $TAG_NAME 创建成功"

      - name: 创建 GitHub Release
        if: steps.check-tag.outputs.tag-exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract-version.outputs.version }}
          name: '� ${{ steps.extract-version.outputs.version }} - 506实验室每日一题'
          body: |
            # 📚 506实验室每日一题 Release ${{ steps.extract-version.outputs.version }}

            ## 🎯 本次发布

            这是一个自动化发布，包含了最新的代码更新和改进。

            ## 📊 项目统计

            - 📚 总题目数量: 持续增长中
            - 👥 活跃贡献者: 多位开发者参与
            - 🛠️ 技术栈: JavaScript, TypeScript, Vite, Vitest

            ## 🚀 快速开始

            ```bash
            # 克隆项目
            git clone https://github.com/506-FETL/one-question-per-day.git

            # 安装依赖
            pnpm install

            # 运行测试
            pnpm test

            # 开发模式
            pnpm dev
            ```

            ## 🤝 参与贡献

            欢迎查看 [README.md](https://github.com/506-FETL/one-question-per-day/blob/main/README.md) 了解如何参与贡献！

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 发布成功通知
        if: steps.check-tag.outputs.tag-exists == 'false'
        run: |
          echo "🎉 发布完成!"
          echo "📚 项目: 506实验室每日一题"
          echo "🏷️ 版本: ${{ steps.extract-version.outputs.version }}"
          echo "� Commit: $(git rev-parse HEAD)"
          echo "✨ GitHub Release 已创建完成"

      - name: 跳过发布通知
        if: steps.check-tag.outputs.tag-exists == 'true'
        run: |
          echo "ℹ️ Tag ${{ steps.extract-version.outputs.version }} 已存在，跳过发布"
          echo "📚 项目: 506实验室每日一题"
          echo "📍 当前 Commit: $(git rev-parse HEAD)"
