name: æ‰‹åŠ¨ Release

on:
  # åªä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œç§»é™¤è‡ªåŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (å¯é€‰ï¼Œæ ¼å¼: v1.2.3)'
        required: false
        type: string
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•æ£€æŸ¥'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  manual-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œé¢„å‘å¸ƒæ£€æŸ¥
        if: ${{ !github.event.inputs.skip_tests }}
        run: |
          pnpm run lint
          pnpm run type-check
          pnpm run test

      - name: ç»Ÿè®¡é¡¹ç›®ä¿¡æ¯
        id: stats
        run: |
          # ç»Ÿè®¡é¢˜ç›®æ•°é‡
          TOTAL_DAYS=$(find problems/days -type d -name "Day *" | wc -l | tr -d ' ')
          echo "total-days=$TOTAL_DAYS" >> $GITHUB_OUTPUT

          # ç»Ÿè®¡è´¡çŒ®è€…
          CONTRIBUTORS=$(git shortlog -sn --all | wc -l | tr -d ' ')
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆç‰ˆæœ¬å·
        id: version
        run: |
          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
            # ç¡®ä¿ç‰ˆæœ¬å·æ ¼å¼æ­£ç¡®
            if [[ ! $NEW_VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "é”™è¯¯ï¼šè‡ªå®šä¹‰ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º v1.2.3"
              exit 1
            fi
          else
            # è·å–å½“å‰ç‰ˆæœ¬
            CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "Current version: $CURRENT_VERSION"
            
            # è§£æç‰ˆæœ¬å·
            VERSION_NUM=${CURRENT_VERSION#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NUM"
            
            # æ ¹æ®é€‰æ‹©çš„ç‰ˆæœ¬ç±»å‹é€’å¢ç‰ˆæœ¬å·
            case "${{ github.event.inputs.version_type }}" in
              "major")
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              "minor")
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              "patch")
                PATCH=$((PATCH + 1))
                ;;
            esac
            
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆ Release Notes
        id: release-notes
        run: |
          # è·å–æœ€æ–°çš„æ›´æ–°æ–‡æ¡£
          LATEST_UPDATE=$(find updates -name "*.md" -not -name "README.md" | sort -r | head -1)

          # å¼€å§‹æ„å»º Release Notes
          cat > release-notes.md << 'EOF'
          # ğŸ“š 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ Release

          ## ğŸ¯ æœ¬æ¬¡æ›´æ–°æ¦‚è§ˆ

          EOF

          # å¦‚æœæœ‰æ›´æ–°æ–‡æ¡£ï¼ŒåŒ…å«å…¶å†…å®¹
          if [ -f "$LATEST_UPDATE" ]; then
            echo "ä» $LATEST_UPDATE ç”Ÿæˆ Release Notes..."
            echo "" >> release-notes.md
            echo "## ğŸ“ è¯¦ç»†æ›´æ–°å†…å®¹" >> release-notes.md
            echo "" >> release-notes.md
            cat "$LATEST_UPDATE" >> release-notes.md
            echo "" >> release-notes.md
          fi

          # æ·»åŠ é¡¹ç›®ç»Ÿè®¡
          echo "## ğŸ“Š é¡¹ç›®ç»Ÿè®¡" >> release-notes.md
          echo "" >> release-notes.md
          echo "- ğŸ“š æ€»é¢˜ç›®æ•°é‡: **${{ steps.stats.outputs.total-days }}** å¤©" >> release-notes.md
          echo "- ğŸ‘¥ è´¡çŒ®è€…æ•°é‡: **${{ steps.stats.outputs.contributors }}** äºº" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ æŠ€æœ¯æ ˆä¿¡æ¯
          echo "## ğŸ› ï¸ æŠ€æœ¯æ ˆ" >> release-notes.md
          echo "" >> release-notes.md
          echo "- **è¯­è¨€**: JavaScript, TypeScript" >> release-notes.md
          echo "- **æµ‹è¯•**: Vitest" >> release-notes.md
          echo "- **ä»£ç è´¨é‡**: ESLint, Prettier" >> release-notes.md
          echo "- **åŒ…ç®¡ç†**: pnpm" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ ä½¿ç”¨è¯´æ˜
          echo "## ğŸš€ å¿«é€Ÿå¼€å§‹" >> release-notes.md
          echo "" >> release-notes.md
          echo "\`\`\`bash" >> release-notes.md
          echo "# å…‹éš†é¡¹ç›®" >> release-notes.md
          echo "git clone https://github.com/506-FETL/one-question-per-day.git" >> release-notes.md
          echo "" >> release-notes.md
          echo "# å®‰è£…ä¾èµ–" >> release-notes.md
          echo "pnpm install" >> release-notes.md
          echo "" >> release-notes.md
          echo "# è¿è¡Œæµ‹è¯•" >> release-notes.md
          echo "pnpm test" >> release-notes.md
          echo "" >> release-notes.md
          echo "# å¼€å‘æ¨¡å¼ï¼ˆåŒ…å«ä»£ç æ£€æŸ¥ã€æ ¼å¼åŒ–ã€æµ‹è¯•ï¼‰" >> release-notes.md
          echo "pnpm dev" >> release-notes.md
          echo "\`\`\`" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ è´¡çŒ®æŒ‡å—é“¾æ¥
          echo "## ğŸ¤ å‚ä¸è´¡çŒ®" >> release-notes.md
          echo "" >> release-notes.md
          echo "æ¬¢è¿åŠ å…¥506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ï¼è¯·æŸ¥çœ‹ [README.md](https://github.com/506-FETL/one-question-per-day/blob/main/README.md) äº†è§£è¯¦ç»†çš„å‚ä¸æŒ‡å—ã€‚" >> release-notes.md
          echo "" >> release-notes.md

          # è¾“å‡ºåˆ°å˜é‡
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: æ›´æ–° CHANGELOG
        id: update-changelog
        run: |
          # è·å–æœ€æ–°çš„æ›´æ–°æ–‡æ¡£
          LATEST_UPDATE=$(find updates -name "*.md" -not -name "README.md" | sort -r | head -1)

          # æ›´æ–° CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            # è·å–å½“å‰æ—¥æœŸ
            CURRENT_DATE=$(date +%Y-%m-%d)
            
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            temp_changelog="changelog-temp.md"
            
            # æŸ¥æ‰¾ [æœªå‘å¸ƒ] è¡Œçš„ä½ç½®
            unreleased_line=$(grep -n "## \[æœªå‘å¸ƒ\]" CHANGELOG.md | cut -d: -f1)
            
            if [ -n "$unreleased_line" ]; then
              # å¤åˆ¶æ–‡ä»¶å¤´éƒ¨åˆ†
              head -n $((unreleased_line + 5)) CHANGELOG.md > $temp_changelog
              
              # æ·»åŠ æ–°ç‰ˆæœ¬æ¡ç›®
              echo "" >> $temp_changelog
              echo "## [${{ steps.version.outputs.version }}] - $CURRENT_DATE" >> $temp_changelog
              echo "" >> $temp_changelog
              
              # å¦‚æœæœ‰æœ€æ–°æ›´æ–°æ–‡æ¡£ï¼Œè§£æå…¶å†…å®¹
              if [ -f "$LATEST_UPDATE" ]; then
                # æå–æ›´æ–°æ–‡æ¡£ä¸­çš„åˆ†ç±»å†…å®¹
                if grep -q "## æ–°å¢åŠŸèƒ½" "$LATEST_UPDATE"; then
                  echo "### æ–°å¢åŠŸèƒ½" >> $temp_changelog
                  sed -n '/## æ–°å¢åŠŸèƒ½/,/## /p' "$LATEST_UPDATE" | sed '1d;$d' | grep '^-' >> $temp_changelog
                  echo "" >> $temp_changelog
                fi
                
                if grep -q "## ä¿®æ”¹å†…å®¹" "$LATEST_UPDATE"; then
                  echo "### ä¿®æ”¹å†…å®¹" >> $temp_changelog
                  sed -n '/## ä¿®æ”¹å†…å®¹/,/## /p' "$LATEST_UPDATE" | sed '1d;$d' | grep '^-' >> $temp_changelog
                  echo "" >> $temp_changelog
                fi
                
                if grep -q "## é—®é¢˜ä¿®å¤\|## ä¿®å¤é—®é¢˜" "$LATEST_UPDATE"; then
                  echo "### é—®é¢˜ä¿®å¤" >> $temp_changelog
                  sed -n '/## é—®é¢˜ä¿®å¤\|## ä¿®å¤é—®é¢˜/,/## /p' "$LATEST_UPDATE" | sed '1d;$d' | grep '^-' >> $temp_changelog
                  echo "" >> $temp_changelog
                fi
              else
                # å¦‚æœæ²¡æœ‰æ›´æ–°æ–‡æ¡£ï¼Œæ·»åŠ é€šç”¨æ¡ç›®
                echo "### æ–°å¢åŠŸèƒ½" >> $temp_changelog
                echo "- æ‰‹åŠ¨å‘å¸ƒç‰ˆæœ¬ ${{ steps.version.outputs.version }}" >> $temp_changelog
                echo "" >> $temp_changelog
              fi
              
              # æ·»åŠ å…¶ä½™å†…å®¹
              tail -n +$((unreleased_line + 6)) CHANGELOG.md >> $temp_changelog
              
              # æ›¿æ¢åŸæ–‡ä»¶
              mv $temp_changelog CHANGELOG.md
              
              echo "changelog-updated=true" >> $GITHUB_OUTPUT
            else
              echo "changelog-updated=false" >> $GITHUB_OUTPUT
              echo "è­¦å‘Š: CHANGELOG.md æ ¼å¼ä¸æ ‡å‡†ï¼Œè·³è¿‡è‡ªåŠ¨æ›´æ–°"
            fi
          else
            echo "changelog-updated=false" >> $GITHUB_OUTPUT
            echo "è­¦å‘Š: CHANGELOG.md ä¸å­˜åœ¨ï¼Œè·³è¿‡è‡ªåŠ¨æ›´æ–°"
          fi

      - name: æ›´æ–° package.json ç‰ˆæœ¬å·
        run: |
          # ç§»é™¤ v å‰ç¼€ç”¨äº package.json
          VERSION_NUMBER=${{ steps.version.outputs.version }}
          VERSION_NUMBER=${VERSION_NUMBER#v}

          # ä½¿ç”¨ pnpm æˆ–è€…ç›´æ¥ä¿®æ”¹ package.json
          if command -v pnpm >/dev/null 2>&1; then
            pnpm version $VERSION_NUMBER --no-git-tag-version
          else
            # å¦‚æœ pnpm ä¸å¯ç”¨ï¼Œä½¿ç”¨ sed ç›´æ¥ä¿®æ”¹
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION_NUMBER\"/" package.json
          fi

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json
          if [ "${{ steps.update-changelog.outputs.changelog-updated }}" = "true" ]; then
            git add CHANGELOG.md
          fi
          git commit -m "chore: release ${{ steps.version.outputs.version }}

          - æ›´æ–° package.json ç‰ˆæœ¬å·
          - æ›´æ–° CHANGELOG.md æ·»åŠ ç‰ˆæœ¬è®°å½•" || echo "No changes to commit"
          git push origin main

      - name: åˆ›å»º Git Tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a ${{ steps.version.outputs.version }} -m "Release ${{ steps.version.outputs.version }}"
          git push origin ${{ steps.version.outputs.version }}

      - name: åˆ›å»º GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: 'ğŸ“š ${{ steps.version.outputs.version }} - 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜'
          body: ${{ steps.release-notes.outputs.RELEASE_NOTES }}
          draft: false
          prerelease: false

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "âœ… Release å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“š é¡¹ç›®: 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "ğŸ“Š æ€»é¢˜ç›®æ•°: ${{ steps.stats.outputs.total-days }} å¤©"
          echo "ğŸ‘¥ è´¡çŒ®è€…: ${{ steps.stats.outputs.contributors }} äºº"
