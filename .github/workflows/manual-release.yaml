name: æ‰‹åŠ¨ Release

on:
  # åªä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œç§»é™¤è‡ªåŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (å¯é€‰ï¼Œæ ¼å¼: v1.2.3)'
        required: false
        type: string
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•æ£€æŸ¥'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  manual-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œé¢„å‘å¸ƒæ£€æŸ¥
        if: ${{ !github.event.inputs.skip_tests }}
        run: |
          pnpm run lint
          pnpm run type-check
          pnpm run test

      - name: ç»Ÿè®¡é¡¹ç›®ä¿¡æ¯
        id: stats
        run: |
          # ç»Ÿè®¡é¢˜ç›®æ•°é‡
          TOTAL_DAYS=$(find problems/days -type d -name "Day *" | wc -l | tr -d ' ')
          echo "total-days=$TOTAL_DAYS" >> $GITHUB_OUTPUT

          # ç»Ÿè®¡è´¡çŒ®è€…ï¼ˆæ’é™¤æœºå™¨äººè´¦æˆ·ï¼Œä½¿ç”¨ mailmap å»é‡ç›¸åŒèº«ä»½ï¼‰
          CONTRIBUTORS=$(git shortlog -sne --all | grep -v -E "(GitHub Action|action@github\.com|xier164.*gitee\.com)" | wc -l | tr -d ' ')
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆç‰ˆæœ¬å·
        id: version
        run: |
          # å‡½æ•°ï¼šéªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          validate_version() {
            local version=$1
            if [[ $version =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?$ ]]; then
              return 0
            else
              return 1
            fi
          }

          # å‡½æ•°ï¼šè§£æç‰ˆæœ¬å·
          parse_version() {
            local version=$1
            # ç§»é™¤ v å‰ç¼€
            version=${version#v}
            # åˆ†ç¦»ä¸»ç‰ˆæœ¬å’Œé¢„å‘å¸ƒæ ‡è¯†
            if [[ $version == *"-"* ]]; then
              local base_version=${version%-*}
              local prerelease=${version#*-}
            else
              local base_version=$version
              local prerelease=""
            fi
            
            # è§£æä¸»ç‰ˆæœ¬å·
            IFS='.' read -r MAJOR MINOR PATCH <<< "$base_version"
            
            # éªŒè¯è§£æç»“æœ
            if [[ ! $MAJOR =~ ^[0-9]+$ ]] || [[ ! $MINOR =~ ^[0-9]+$ ]] || [[ ! $PATCH =~ ^[0-9]+$ ]]; then
              echo "é”™è¯¯ï¼šæ— æ³•è§£æç‰ˆæœ¬å· $1"
              exit 1
            fi
            
            echo "$MAJOR $MINOR $PATCH $prerelease"
          }

          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
            echo "ä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬å·: $NEW_VERSION"
            
            # éªŒè¯è‡ªå®šä¹‰ç‰ˆæœ¬å·æ ¼å¼
            if ! validate_version "$NEW_VERSION"; then
              echo "é”™è¯¯ï¼šè‡ªå®šä¹‰ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®"
              echo "æ”¯æŒçš„æ ¼å¼: v1.2.3 æˆ– v1.2.3-beta.1"
              exit 1
            fi
          else
            # è·å–å½“å‰æœ€æ–°ç‰ˆæœ¬
            CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null)
            
            if [ -z "$CURRENT_VERSION" ]; then
              # å¦‚æœæ²¡æœ‰ä»»ä½•æ ‡ç­¾ï¼Œä» package.json è·å–å½“å‰ç‰ˆæœ¬
              PACKAGE_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "1.0.0")
              CURRENT_VERSION="v$PACKAGE_VERSION"
              echo "æ²¡æœ‰æ‰¾åˆ° Git æ ‡ç­¾ï¼Œä½¿ç”¨ package.json ç‰ˆæœ¬: $CURRENT_VERSION"
            else
              echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
            fi
            
            # éªŒè¯å½“å‰ç‰ˆæœ¬æ ¼å¼
            if ! validate_version "$CURRENT_VERSION"; then
              echo "è­¦å‘Šï¼šå½“å‰ç‰ˆæœ¬æ ¼å¼ä¸æ ‡å‡†ï¼Œé‡ç½®ä¸º v1.0.0"
              CURRENT_VERSION="v1.0.0"
            fi
            
            # è§£æå½“å‰ç‰ˆæœ¬
            read -r MAJOR MINOR PATCH PRERELEASE <<< "$(parse_version "$CURRENT_VERSION")"
            
            echo "è§£æç»“æœ: MAJOR=$MAJOR, MINOR=$MINOR, PATCH=$PATCH, PRERELEASE=$PRERELEASE"
            
            # æ ¹æ®é€‰æ‹©çš„ç‰ˆæœ¬ç±»å‹é€’å¢ç‰ˆæœ¬å·
            case "${{ github.event.inputs.version_type }}" in
              "major")
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                echo "å‡çº§ä¸»ç‰ˆæœ¬: $MAJOR.0.0"
                ;;
              "minor")
                MINOR=$((MINOR + 1))
                PATCH=0
                echo "å‡çº§æ¬¡ç‰ˆæœ¬: $MAJOR.$MINOR.0"
                ;;
              "patch")
                PATCH=$((PATCH + 1))
                echo "å‡çº§è¡¥ä¸ç‰ˆæœ¬: $MAJOR.$MINOR.$PATCH"
                ;;
              *)
                echo "é”™è¯¯ï¼šä¸æ”¯æŒçš„ç‰ˆæœ¬ç±»å‹ ${{ github.event.inputs.version_type }}"
                exit 1
                ;;
            esac
            
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "ğŸ·ï¸ æ–°ç‰ˆæœ¬å·: $NEW_VERSION"

          # éªŒè¯æœ€ç»ˆç‰ˆæœ¬å·
          if ! validate_version "$NEW_VERSION"; then
            echo "é”™è¯¯ï¼šç”Ÿæˆçš„ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®: $NEW_VERSION"
            exit 1
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        id: create-release-package
        run: |
          echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ… (ä»…åŒ…å« problems ç›®å½•)"

          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…
          TEMP_DIR="release-temp"
          PACKAGE_NAME="506-lab-daily-questions-${{ steps.version.outputs.version }}"

          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„ä¸´æ—¶ç›®å½•
          rm -rf "$TEMP_DIR" || true

          # åˆ›å»ºæ‰“åŒ…ç›®å½•ç»“æ„
          mkdir -p "$TEMP_DIR/$PACKAGE_NAME"

          # å¤åˆ¶ problems ç›®å½•
          cp -r problems "$TEMP_DIR/$PACKAGE_NAME/"

          # åˆ›å»ºåŒ…ä¿¡æ¯æ–‡ä»¶
          cat > "$TEMP_DIR/$PACKAGE_NAME/README.md" << EOF
          # 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ - ${{ steps.version.outputs.version }}

          ğŸ“š **é¢˜ç›®æ€»æ•°**: ${{ steps.stats.outputs.total-days }} é¢˜  
          ğŸ‘¥ **è´¡çŒ®è€…**: ${{ steps.stats.outputs.contributors }} äºº  
          ğŸ“… **å‘å¸ƒæ—¥æœŸ**: $(date +%Y-%m-%d)  

          ## ğŸ“ ç›®å½•ç»“æ„

          \`\`\`
          problems/
          â”œâ”€â”€ days/           # æ¯æ—¥é¢˜ç›®
          â”‚   â”œâ”€â”€ Day 01/     # ç¬¬1å¤©é¢˜ç›®
          â”‚   â”œâ”€â”€ Day 02/     # ç¬¬2å¤©é¢˜ç›®
          â”‚   â””â”€â”€ ...
          â””â”€â”€ review/         # å¤ä¹ æ€»ç»“
              â”œâ”€â”€ 01.md       # ç¬¬1å¤©å¤ä¹ 
              â”œâ”€â”€ 02.md       # ç¬¬2å¤©å¤ä¹   
              â””â”€â”€ ...
          \`\`\`

          ## ğŸš€ ä½¿ç”¨è¯´æ˜

          1. æ¯ä¸ª Day ç›®å½•åŒ…å«ï¼š
             - \`README.md\` - é¢˜ç›®æè¿°
             - \`answer.js\` - å‚è€ƒç­”æ¡ˆ
             - é¢˜ç›®ç›¸å…³çš„ JavaScript æ–‡ä»¶
             - å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶ (\`*.spec.js\`)
             - \`ts/\` ç›®å½• - TypeScript ç‰ˆæœ¬å®ç°

          2. review ç›®å½•åŒ…å«æ¯å¤©çš„å¤ä¹ æ€»ç»“

          ## ğŸŒ é¡¹ç›®åœ°å€

          - GitHub: https://github.com/506-FETL/one-question-per-day
          - å®Œæ•´é¡¹ç›®åŒ…å«æµ‹è¯•ç¯å¢ƒã€å¼€å‘å·¥å…·ç­‰ï¼Œè¯·è®¿é—® GitHub è·å–

          ---

          **506å®éªŒå®¤** - è®©å­¦ä¹ æˆä¸ºä¹ æƒ¯ âœ¨
          EOF

          # åˆ›å»ºå‹ç¼©åŒ…
          cd "$TEMP_DIR"
          tar -czf "../$PACKAGE_NAME.tar.gz" "$PACKAGE_NAME"
          zip -r "../$PACKAGE_NAME.zip" "$PACKAGE_NAME"
          cd ..

          # è®¡ç®—æ–‡ä»¶å¤§å°å’Œå“ˆå¸Œ
          TAR_SIZE=$(du -h "$PACKAGE_NAME.tar.gz" | cut -f1)
          ZIP_SIZE=$(du -h "$PACKAGE_NAME.zip" | cut -f1)
          TAR_SHA256=$(shasum -a 256 "$PACKAGE_NAME.tar.gz" | cut -d' ' -f1)
          ZIP_SHA256=$(shasum -a 256 "$PACKAGE_NAME.zip" | cut -d' ' -f1)

          echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ:"
          echo "ğŸ“¦ $PACKAGE_NAME.tar.gz ($TAR_SIZE)"
          echo "ğŸ“¦ $PACKAGE_NAME.zip ($ZIP_SIZE)"
          echo ""
          echo "ğŸ” SHA256 æ ¡éªŒç :"
          echo "tar.gz: $TAR_SHA256"
          echo "zip: $ZIP_SHA256"

          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf "$TEMP_DIR"

          # è¾“å‡ºåˆ° GitHub Actions
          echo "package-name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "tar-file=$PACKAGE_NAME.tar.gz" >> $GITHUB_OUTPUT
          echo "zip-file=$PACKAGE_NAME.zip" >> $GITHUB_OUTPUT
          echo "tar-size=$TAR_SIZE" >> $GITHUB_OUTPUT
          echo "zip-size=$ZIP_SIZE" >> $GITHUB_OUTPUT
          echo "tar-sha256=$TAR_SHA256" >> $GITHUB_OUTPUT
          echo "zip-sha256=$ZIP_SHA256" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆ Release Notes
        id: release-notes
        run: |
          # è·å–æœ€æ–°çš„æ›´æ–°æ–‡æ¡£
          LATEST_UPDATE=$(find updates -name "*.md" -not -name "README.md" | sort -r | head -1)

          # å¼€å§‹æ„å»º Release Notes
          cat > release-notes.md << 'EOF'
          # ğŸ“š 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ Release

          ## ğŸ¯ æœ¬æ¬¡æ›´æ–°æ¦‚è§ˆ

          EOF

          # å¦‚æœæœ‰æ›´æ–°æ–‡æ¡£ï¼ŒåŒ…å«å…¶å†…å®¹
          if [ -f "$LATEST_UPDATE" ]; then
            echo "ä» $LATEST_UPDATE ç”Ÿæˆ Release Notes..."
            echo "" >> release-notes.md
            echo "## ğŸ“ è¯¦ç»†æ›´æ–°å†…å®¹" >> release-notes.md
            echo "" >> release-notes.md
            cat "$LATEST_UPDATE" >> release-notes.md
            echo "" >> release-notes.md
          fi

          # æ·»åŠ é¡¹ç›®ç»Ÿè®¡
          echo "## ğŸ“Š é¡¹ç›®ç»Ÿè®¡" >> release-notes.md
          echo "" >> release-notes.md
          echo "- ğŸ“š æ€»é¢˜ç›®æ•°é‡: **${{ steps.stats.outputs.total-days }}** é¢˜" >> release-notes.md
          echo "- ğŸ‘¥ è´¡çŒ®è€…æ•°é‡: **${{ steps.stats.outputs.contributors }}** äºº" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ å‘å¸ƒåŒ…ä¿¡æ¯
          echo "## ğŸ“¦ å‘å¸ƒåŒ…ä¸‹è½½" >> release-notes.md
          echo "" >> release-notes.md
          echo "æœ¬ç‰ˆæœ¬æä¾›ä»¥ä¸‹å‘å¸ƒåŒ…ï¼ˆä»…åŒ…å«é¢˜ç›®æ–‡ä»¶ï¼‰ï¼š" >> release-notes.md
          echo "" >> release-notes.md
          echo "| æ ¼å¼ | æ–‡ä»¶å | å¤§å° | SHA256 |" >> release-notes.md
          echo "|------|--------|------|--------|" >> release-notes.md
          echo "| ZIP | \`${{ steps.create-release-package.outputs.zip-file }}\` | ${{ steps.create-release-package.outputs.zip-size }} | \`${{ steps.create-release-package.outputs.zip-sha256 }}\` |" >> release-notes.md
          echo "| TAR.GZ | \`${{ steps.create-release-package.outputs.tar-file }}\` | ${{ steps.create-release-package.outputs.tar-size }} | \`${{ steps.create-release-package.outputs.tar-sha256 }}\` |" >> release-notes.md
          echo "" >> release-notes.md
          echo "ğŸ“ **åŒ…å«å†…å®¹**ï¼š" >> release-notes.md
          echo "- \`problems/days/\` - æ‰€æœ‰æ¯æ—¥é¢˜ç›®ï¼ˆDay 01 - Day ${{ steps.stats.outputs.total-days }}ï¼‰" >> release-notes.md
          echo "- \`problems/review/\` - å¤ä¹ æ€»ç»“æ–‡æ¡£" >> release-notes.md
          echo "- \`README.md\` - ä½¿ç”¨è¯´æ˜å’Œç›®å½•ç»“æ„" >> release-notes.md
          echo "" >> release-notes.md
          echo "ğŸ’¡ **æ³¨æ„**ï¼šå‘å¸ƒåŒ…ä»…åŒ…å«é¢˜ç›®æ–‡ä»¶ï¼Œå¦‚éœ€å®Œæ•´å¼€å‘ç¯å¢ƒè¯·å…‹éš† GitHub ä»“åº“ã€‚" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ æŠ€æœ¯æ ˆä¿¡æ¯
          echo "## ğŸ› ï¸ æŠ€æœ¯æ ˆ" >> release-notes.md
          echo "" >> release-notes.md
          echo "- **è¯­è¨€**: JavaScript, TypeScript" >> release-notes.md
          echo "- **æµ‹è¯•**: Vitest" >> release-notes.md
          echo "- **ä»£ç è´¨é‡**: ESLint, Prettier" >> release-notes.md
          echo "- **åŒ…ç®¡ç†**: pnpm" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ ä½¿ç”¨è¯´æ˜
          echo "## ğŸš€ å¿«é€Ÿå¼€å§‹" >> release-notes.md
          echo "" >> release-notes.md
          echo "\`\`\`bash" >> release-notes.md
          echo "# å…‹éš†é¡¹ç›®" >> release-notes.md
          echo "git clone https://github.com/506-FETL/one-question-per-day.git" >> release-notes.md
          echo "" >> release-notes.md
          echo "# å®‰è£…ä¾èµ–" >> release-notes.md
          echo "pnpm install" >> release-notes.md
          echo "" >> release-notes.md
          echo "# è¿è¡Œæµ‹è¯•" >> release-notes.md
          echo "pnpm test" >> release-notes.md
          echo "" >> release-notes.md
          echo "# å¼€å‘æ¨¡å¼ï¼ˆåŒ…å«ä»£ç æ£€æŸ¥ã€æ ¼å¼åŒ–ã€æµ‹è¯•ï¼‰" >> release-notes.md
          echo "pnpm dev" >> release-notes.md
          echo "\`\`\`" >> release-notes.md
          echo "" >> release-notes.md

          # æ·»åŠ è´¡çŒ®æŒ‡å—é“¾æ¥
          echo "## ğŸ¤ å‚ä¸è´¡çŒ®" >> release-notes.md
          echo "" >> release-notes.md
          echo "æ¬¢è¿åŠ å…¥506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ï¼è¯·æŸ¥çœ‹ [README.md](https://github.com/506-FETL/one-question-per-day/blob/main/README.md) äº†è§£è¯¦ç»†çš„å‚ä¸æŒ‡å—ã€‚" >> release-notes.md
          echo "" >> release-notes.md

          # è¾“å‡ºåˆ°å˜é‡
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: æ›´æ–° CHANGELOG
        id: update-changelog
        run: |
          # è·å–æœ€æ–°çš„æ›´æ–°æ–‡æ¡£
          LATEST_UPDATE=$(find updates -name "*.md" -not -name "README.md" | sort -r | head -1)

          # æ›´æ–° CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            # è·å–å½“å‰æ—¥æœŸ
            CURRENT_DATE=$(date +%Y-%m-%d)
            
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
            temp_changelog="changelog-temp.md"
            
            # æŸ¥æ‰¾ [æœªå‘å¸ƒ] è¡Œçš„ä½ç½®
            unreleased_line=$(grep -n "## \[æœªå‘å¸ƒ\]" CHANGELOG.md | cut -d: -f1)
            
            if [ -n "$unreleased_line" ]; then
              # å¤åˆ¶æ–‡ä»¶å¤´éƒ¨åˆ†
              head -n $((unreleased_line + 5)) CHANGELOG.md > $temp_changelog
              
              # æ·»åŠ æ–°ç‰ˆæœ¬æ¡ç›®
              echo "" >> $temp_changelog
              echo "## [${{ steps.version.outputs.version }}] - $CURRENT_DATE" >> $temp_changelog
              echo "" >> $temp_changelog
              
              # å¦‚æœæœ‰æœ€æ–°æ›´æ–°æ–‡æ¡£ï¼Œç›´æ¥æ·»åŠ å…¶å†…å®¹
              if [ -f "$LATEST_UPDATE" ]; then
                echo "### æ›´æ–°å†…å®¹" >> $temp_changelog
                echo "" >> $temp_changelog
                # è·å–æ›´æ–°æ–‡æ¡£çš„æ ‡é¢˜
                echo "**$(head -1 "$LATEST_UPDATE" | sed 's/^# //')**" >> $temp_changelog
                echo "" >> $temp_changelog
                # æ·»åŠ æ›´æ–°æ¦‚è¿°ï¼ˆè·³è¿‡æ ‡é¢˜å’Œå…ƒä¿¡æ¯ï¼Œæå–ä¸»è¦å†…å®¹ï¼‰
                sed -n '/## /,$p' "$LATEST_UPDATE" | head -20 | grep -E '^- |^## ' | sed 's/^## /#### /' >> $temp_changelog
                echo "" >> $temp_changelog
                echo "è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹: [æ›´æ–°æ–‡æ¡£]($LATEST_UPDATE)" >> $temp_changelog
                echo "" >> $temp_changelog
              else
                # å¦‚æœæ²¡æœ‰æ›´æ–°æ–‡æ¡£ï¼Œæ·»åŠ é€šç”¨æ¡ç›®
                echo "### æ›´æ–°å†…å®¹" >> $temp_changelog
                echo "- æ‰‹åŠ¨å‘å¸ƒç‰ˆæœ¬ ${{ steps.version.outputs.version }}" >> $temp_changelog
                echo "" >> $temp_changelog
              fi
              
              # æ·»åŠ å…¶ä½™å†…å®¹
              tail -n +$((unreleased_line + 6)) CHANGELOG.md >> $temp_changelog
              
              # æ›¿æ¢åŸæ–‡ä»¶
              mv $temp_changelog CHANGELOG.md
              
              echo "changelog-updated=true" >> $GITHUB_OUTPUT
            else
              echo "changelog-updated=false" >> $GITHUB_OUTPUT
              echo "è­¦å‘Š: CHANGELOG.md æ ¼å¼ä¸æ ‡å‡†ï¼Œè·³è¿‡è‡ªåŠ¨æ›´æ–°"
            fi
          else
            echo "changelog-updated=false" >> $GITHUB_OUTPUT
            echo "è­¦å‘Š: CHANGELOG.md ä¸å­˜åœ¨ï¼Œè·³è¿‡è‡ªåŠ¨æ›´æ–°"
          fi

      - name: æ›´æ–° package.json ç‰ˆæœ¬å·
        run: |
          # ç§»é™¤ v å‰ç¼€ç”¨äº package.json
          VERSION_NUMBER=${{ steps.version.outputs.version }}
          VERSION_NUMBER=${VERSION_NUMBER#v}

          # ä½¿ç”¨ pnpm æˆ–è€…ç›´æ¥ä¿®æ”¹ package.json
          if command -v pnpm >/dev/null 2>&1; then
            pnpm version $VERSION_NUMBER --no-git-tag-version
          else
            # å¦‚æœ pnpm ä¸å¯ç”¨ï¼Œä½¿ç”¨ sed ç›´æ¥ä¿®æ”¹
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION_NUMBER\"/" package.json
          fi

      - name: åˆ›å»ºå‘å¸ƒåˆ†æ”¯
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          BRANCH_NAME="release/${{ steps.version.outputs.version }}"

          # æ£€æŸ¥è¿œç¨‹åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
            echo "âš ï¸ è¿œç¨‹åˆ†æ”¯ $BRANCH_NAME å·²å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤..."
            git push origin --delete $BRANCH_NAME || echo "åˆ é™¤è¿œç¨‹åˆ†æ”¯å¤±è´¥ï¼Œå¯èƒ½å·²è¢«åˆ é™¤"
          fi

          # æ£€æŸ¥æœ¬åœ°åˆ†æ”¯æ˜¯å¦å­˜åœ¨å¹¶åˆ é™¤
          if git show-ref --verify --quiet refs/heads/$BRANCH_NAME; then
            echo "âš ï¸ æœ¬åœ°åˆ†æ”¯ $BRANCH_NAME å·²å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤..."
            git branch -D $BRANCH_NAME
          fi

          # åˆ›å»ºæ–°åˆ†æ”¯
          git checkout -b $BRANCH_NAME
          echo "âœ… åˆ›å»ºæ–°åˆ†æ”¯: $BRANCH_NAME"
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        id: create-branch

      - name: æäº¤æ›´æ”¹åˆ°å‘å¸ƒåˆ†æ”¯
        run: |
          git add package.json
          if [ "${{ steps.update-changelog.outputs.changelog-updated }}" = "true" ]; then
            git add CHANGELOG.md
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "chore: release ${{ steps.version.outputs.version }}

          - æ›´æ–° package.json ç‰ˆæœ¬å·
          - æ›´æ–° CHANGELOG.md æ·»åŠ ç‰ˆæœ¬è®°å½•"
            echo "âœ… æäº¤å®Œæˆ"
          fi

          # å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹ï¼ˆå› ä¸ºæˆ‘ä»¬å·²ç»æ¸…ç†äº†å†²çªçš„åˆ†æ”¯ï¼‰
          git push origin ${{ steps.create-branch.outputs.branch-name }}

      - name: åˆ›å»ºæˆ–æ›´æ–° Pull Request
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CONTRIB_TOKEN }}
          script: |
            const branchName = '${{ steps.create-branch.outputs.branch-name }}';
            const version = '${{ steps.version.outputs.version }}';

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„å¼€æ”¾PR
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });

            if (existingPRs.length > 0) {
              const existingPR = existingPRs[0];
              console.log(`âš ï¸ å‘ç°ç°æœ‰çš„PR #${existingPR.number}: ${existingPR.html_url}`);
              
              // æ›´æ–°ç°æœ‰PRçš„æè¿°
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: existingPR.number,
                body: `## ğŸ“š 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ Release (æ›´æ–°)

            ### ğŸ¯ å‘å¸ƒå†…å®¹
            - ç‰ˆæœ¬å·æ›´æ–°è‡³ ${version}
            - æ›´æ–° CHANGELOG.md
            - æ€»é¢˜ç›®æ•°é‡: ${{ steps.stats.outputs.total-days }} å¤©
            - è´¡çŒ®è€…æ•°é‡: ${{ steps.stats.outputs.contributors }} äºº

            ### ğŸ” è‡ªåŠ¨æ£€æŸ¥
            æ­¤ PR å°†è‡ªåŠ¨è§¦å‘å¿…è¦çš„æ£€æŸ¥ï¼š
            - âœ… ä»£ç æ ¼å¼æ£€æŸ¥ (Lint)
            - âœ… ç±»å‹æ£€æŸ¥ (Type Check)  
            - âœ… å•å…ƒæµ‹è¯• (Test)

            ### ğŸ“ ä¸‹ä¸€æ­¥
            1. ç­‰å¾…æ‰€æœ‰æ£€æŸ¥é€šè¿‡
            2. åˆå¹¶æ­¤ PR åˆ° main åˆ†æ”¯
            3. è‡ªåŠ¨åˆ›å»º Git Tag å’Œ GitHub Release

            ---
            *æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°äº ${new Date().toISOString()}*`
              });
              
              core.setOutput('pr_number', existingPR.number);
              core.setOutput('pr_url', existingPR.html_url);
              core.setOutput('pr_action', 'updated');
              
              return existingPR.number;
            }

            // åˆ›å»ºæ–°çš„PR
            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš€ Release ${version}`,
              head: branchName,
              base: 'main',
              body: `## ğŸ“š 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜ Release

            ### ğŸ¯ å‘å¸ƒå†…å®¹
            - ç‰ˆæœ¬å·æ›´æ–°è‡³ ${version}
            - æ›´æ–° CHANGELOG.md
            - æ€»é¢˜ç›®æ•°é‡: ${{ steps.stats.outputs.total-days }} å¤©
            - è´¡çŒ®è€…æ•°é‡: ${{ steps.stats.outputs.contributors }} äºº

            ### ğŸ” è‡ªåŠ¨æ£€æŸ¥
            æ­¤ PR å°†è‡ªåŠ¨è§¦å‘å¿…è¦çš„æ£€æŸ¥ï¼š
            - âœ… ä»£ç æ ¼å¼æ£€æŸ¥ (Lint)
            - âœ… ç±»å‹æ£€æŸ¥ (Type Check)  
            - âœ… å•å…ƒæµ‹è¯• (Test)

            ### ğŸ“ ä¸‹ä¸€æ­¥
            1. ç­‰å¾…æ‰€æœ‰æ£€æŸ¥é€šè¿‡
            2. åˆå¹¶æ­¤ PR åˆ° main åˆ†æ”¯
            3. è‡ªåŠ¨åˆ›å»º Git Tag å’Œ GitHub Release

            ---
            *æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`
            });

            core.setOutput('pr_number', pullRequest.number);
            core.setOutput('pr_url', pullRequest.html_url);
            core.setOutput('pr_action', 'created');

            return pullRequest.number;

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "âœ… Release PR å¤„ç†å®Œæˆ!"
          echo ""
          echo "ğŸ“š é¡¹ç›®: 506å®éªŒå®¤æ¯æ—¥ä¸€é¢˜"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "ğŸ“Š æ€»é¢˜ç›®æ•°: ${{ steps.stats.outputs.total-days }} å¤©"
          echo "ğŸ‘¥ è´¡çŒ®è€…: ${{ steps.stats.outputs.contributors }} äºº"
          echo ""
          echo "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
          echo "1. è®¿é—® GitHub PR é¡µé¢"
          echo "2. ç­‰å¾…æ‰€æœ‰ CI æ£€æŸ¥é€šè¿‡"
          echo "3. æ‰‹åŠ¨åˆå¹¶ PR åˆ° main åˆ†æ”¯"
          echo "4. åˆå¹¶åè‡ªåŠ¨åˆ›å»º Git Tag å’Œ GitHub Release"
