# Jest

## é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ Jest æµ‹è¯•æ¡†æ¶æ ¸å¿ƒåŠŸèƒ½ï¼š

- `expect(value).toBe(expected)` - åŸºæœ¬ç›¸ç­‰æ–­è¨€
- `expect(value).not.toBe(expected)` - å–åæ–­è¨€
- è¿”å› `true`ï¼ˆé€šè¿‡ï¼‰æˆ– `false`ï¼ˆå¤±è´¥ï¼‰

```js
expect(3).toBe(3) // âœ… true
expect(4).toBe(3) // âŒ false
expect(3).not.toBe(3) // âŒ false
expect(4).not.toBe(3) // âœ… true
```

**æ‰©å±•æ€è€ƒ**: å¦‚ä½•é¿å…ç¡¬ç¼–ç ï¼Œæé«˜ä»£ç å¥å£®æ€§ï¼Ÿ

æœ¬é¢˜è€ƒæŸ¥ **æµ‹è¯•æ¡†æ¶è®¾è®¡**ã€**é“¾å¼è°ƒç”¨** å’Œ **getter æ–¹æ³•** çš„ä½¿ç”¨ã€‚

## æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. æµ‹è¯•æ¡†æ¶åŸºç¡€

- **æ–­è¨€ (Assertion)**: éªŒè¯ä»£ç è¡Œä¸ºæ˜¯å¦ç¬¦åˆé¢„æœŸ
- **æµ‹è¯•ç”¨ä¾‹**: åŒ…å«è¾“å…¥ã€é¢„æœŸè¾“å‡ºå’Œå®é™…è¾“å‡ºçš„æ¯”è¾ƒ
- **åŒ¹é…å™¨ (Matcher)**: å¦‚ `toBe`ã€`toEqual`ã€`toContain` ç­‰
- **ä¿®é¥°ç¬¦**: å¦‚ `not` ç”¨äºå–åæ–­è¨€ç»“æœ

### 2. Object.is() vs ===

- **Object.is()**: æ›´ä¸¥æ ¼çš„ç›¸ç­‰æ¯”è¾ƒ
- **ç‰¹æ®Šæƒ…å†µ**: `NaN === NaN` (false) vs `Object.is(NaN, NaN)` (true)
- **0 å’Œ -0**: `0 === -0` (true) vs `Object.is(0, -0)` (false)
- **Jest é€‰æ‹©**: Jest çš„ `toBe` å†…éƒ¨ä½¿ç”¨ `Object.is`

### 3. getter æ–¹æ³•çš„å¦™ç”¨

- **åŠ¨æ€è®¡ç®—**: æ¯æ¬¡è®¿é—®æ—¶æ‰§è¡Œé€»è¾‘
- **é“¾å¼è°ƒç”¨**: è¿”å› `this` å®ç°æ–¹æ³•é“¾
- **çŠ¶æ€åˆ‡æ¢**: é€šè¿‡ getter æ”¹å˜å†…éƒ¨çŠ¶æ€

## ä»£ç å®ç°

```javascript
/**
 * @param {any} input
 * @returns {ExpectObject}
 */
export default function myExpect(input) {
  let isReversed = false // æ ‡è®°æ˜¯å¦ä½¿ç”¨ not ä¿®é¥°ç¬¦

  return {
    toBe(checker) {
      const isEqual = Object.is(input, checker)

      // æ ¹æ®æ˜¯å¦ä½¿ç”¨ not å†³å®šç»“æœ
      // not + ç›¸ç­‰ = false, not + ä¸ç›¸ç­‰ = true
      // æ™®é€š + ç›¸ç­‰ = true, æ™®é€š + ä¸ç›¸ç­‰ = false
      if ((isReversed && isEqual) || (!isReversed && !isEqual)) {
        return false
      }
      else {
        return true
      }
    },

    get not() {
      isReversed = !isReversed // åˆ‡æ¢å–åçŠ¶æ€
      return this // è¿”å›è‡ªèº«æ”¯æŒé“¾å¼è°ƒç”¨
    },
  }
}
```

## ç®—æ³•åˆ†æ

- **æ—¶é—´å¤æ‚åº¦**: O(1) - å¸¸æ•°æ—¶é—´æ“ä½œ
- **ç©ºé—´å¤æ‚åº¦**: O(1) - åªå­˜å‚¨å¿…è¦çš„çŠ¶æ€å˜é‡
- **ç‰¹ç‚¹**: æ”¯æŒé“¾å¼è°ƒç”¨ã€çŠ¶æ€ç®¡ç†ã€çµæ´»æ‰©å±•

## å…³é”®æŠ€æœ¯ç‚¹

### 1. é€»è¾‘åˆ¤æ–­çš„ç®€åŒ–

```javascript
// åŸå§‹å¤æ‚é€»è¾‘
if (isReversed) {
  return !isEqual; // not ä¿®é¥°ç¬¦ï¼šå–åç»“æœ
} else {
  return isEqual; // æ­£å¸¸æƒ…å†µï¼šç›´æ¥è¿”å›
}

// ç®€åŒ–åçš„é€»è¾‘
if ((isReversed && isEqual) || (!isReversed && !isEqual)) {
  return false;
} else {
  return true;
}

// è¿›ä¸€æ­¥ç®€åŒ–
return !((isReversed && isEqual) || (!isReversed && !isEqual));

// å¾·æ‘©æ ¹å®šå¾‹
return (!isReversed || !isEqual) && (isReversed || isEqual);

// æœ€ç»ˆç®€åŒ–
return isReversed ? !isEqual : isEqual;
```

### 2. getter çš„é“¾å¼è°ƒç”¨æœºåˆ¶

```javascript
get not() {
  console.log('Accessing not getter')
  isReversed = !isReversed
  return this // å…³é”®ï¼šè¿”å› this å¯¹è±¡
}

// ä½¿ç”¨ç¤ºä¾‹
const expectObj = myExpect(3)
expectObj.not.not.not.toBe(4) // å¯ä»¥å¤šæ¬¡é“¾å¼è°ƒç”¨
```

### 3. Object.is() çš„ç‰¹æ®Šæƒ…å†µ

```javascript
// æµ‹è¯• Object.is ä¸ === çš„å·®å¼‚
console.log(Number.NaN === Number.NaN) // false
console.log(Object.is(Number.NaN, Number.NaN)) // true

console.log(0 === -0) // true
console.log(Object.is(0, -0)) // false

console.log(+0 === -0) // true
console.log(Object.is(+0, -0)) // false

// ä¸ºä»€ä¹ˆ Jest é€‰æ‹© Object.isï¼Ÿ
// 1. æ›´ç¬¦åˆæ•°å­¦ç›´è§‰ï¼ˆNaN ç­‰äºè‡ªèº«ï¼‰
// 2. åŒºåˆ† +0 å’Œ -0 çš„ç»†å¾®å·®åˆ«
// 3. æä¾›æ›´ä¸¥æ ¼çš„ç›¸ç­‰æ€§æ£€æŸ¥
```

### 4. å¸¸è§é™·é˜±å’Œå‘ç‚¹

- **çŠ¶æ€æ±¡æŸ“**: `not` çŠ¶æ€åœ¨å¤šæ¬¡è°ƒç”¨é—´å¯èƒ½è¢«æ±¡æŸ“
- **é“¾å¼è°ƒç”¨ç†è§£**: getter æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œï¼Œä¿®æ”¹çŠ¶æ€
- **ç›¸ç­‰æ¯”è¾ƒé€‰æ‹©**: é€‰æ‹©åˆé€‚çš„æ¯”è¾ƒæ–¹æ³•å¾ˆé‡è¦
- **è¿”å›å€¼æ··æ·†**: æ–­è¨€ç»“æœåº”è¯¥è¿”å›å¸ƒå°”å€¼

## ä½¿ç”¨ç¤ºä¾‹

```javascript
// åŸºæœ¬ä½¿ç”¨
console.log(myExpect(3).toBe(3)) // true
console.log(myExpect(4).toBe(3)) // false

// not ä¿®é¥°ç¬¦
console.log(myExpect(3).not.toBe(3)) // false
console.log(myExpect(4).not.toBe(3)) // true

// ç‰¹æ®Šå€¼æµ‹è¯•
console.log(myExpect(Number.NaN).toBe(Number.NaN)) // true (Object.is)
console.log(myExpect(0).toBe(-0)) // false (Object.is)
console.log(myExpect(null).toBe(null)) // true
console.log(myExpect(undefined).toBe(undefined)) // true

// å¯¹è±¡å¼•ç”¨æ¯”è¾ƒ
const obj1 = { a: 1 }
const obj2 = { a: 1 }
console.log(myExpect(obj1).toBe(obj1)) // true (åŒä¸€å¼•ç”¨)
console.log(myExpect(obj1).toBe(obj2)) // false (ä¸åŒå¼•ç”¨)

// å¤šé‡ not é“¾å¼è°ƒç”¨
console.log(myExpect(3).not.not.toBe(3)) // true (åŒé‡å¦å®š)
console.log(myExpect(3).not.not.not.toBe(3)) // false (ä¸‰é‡å¦å®š)

// ç±»å‹ä¸¥æ ¼æ¯”è¾ƒ
console.log(myExpect(1).toBe('1')) // false
console.log(myExpect(true).toBe(1)) // false
console.log(myExpect(null).toBe(undefined)) // false

// è¾¹ç•Œæƒ…å†µ
console.log(myExpect(Infinity).toBe(Infinity)) // true
console.log(myExpect(-Infinity).toBe(-Infinity)) // true
console.log(myExpect(Symbol('a')).toBe(Symbol('a'))) // false (ä¸åŒ Symbol)
```

## è®°å¿†è¦ç‚¹

### æ ¸å¿ƒè®°å¿†ç‚¹

1. **Object.is() æ›´ä¸¥æ ¼** - å¤„ç† NaN å’Œ Â±0 çš„ç‰¹æ®Šæƒ…å†µ
2. **getter è¿”å› this** - å®ç°é“¾å¼è°ƒç”¨çš„å…³é”®
3. **çŠ¶æ€ç®¡ç†** - isReversed å˜é‡æ§åˆ¶å–åé€»è¾‘
4. **é€»è¾‘ç®€åŒ–** - å¼‚æˆ–é€»è¾‘ç®€åŒ–å¤æ‚åˆ¤æ–­
5. **Jest é£æ ¼** - è¿”å›å¸ƒå°”å€¼è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸

### è®¾è®¡æ¨¡å¼

```javascript
// å»ºé€ è€…æ¨¡å¼ + é“¾å¼è°ƒç”¨
const result = myExpect(value)
  .not // ä¿®é¥°ç¬¦
  .toBe(expected) // æ–­è¨€æ–¹æ³•

// çŠ¶æ€æœºæ¨¡å¼
// State: normal -> not -> normal -> not
```

## æ‰©å±•æ€è€ƒ

### 1. é¿å…ç¡¬ç¼–ç çš„æ”¹è¿›ç‰ˆæœ¬

```javascript
function myExpect(input) {
  const modifiers = { isReversed: false }

  const expectObj = {
    toBe(checker) {
      const isEqual = Object.is(input, checker)
      return modifiers.isReversed ? !isEqual : isEqual
    },
  }

  // åŠ¨æ€æ·»åŠ  not getter
  Object.defineProperty(expectObj, 'not', {
    get() {
      modifiers.isReversed = !modifiers.isReversed
      return this
    },
  })

  return expectObj
}
```

### 2. æ”¯æŒæ›´å¤šåŒ¹é…å™¨

```javascript
function myExpectExtended(input) {
  let isReversed = false

  const matchers = {
    toBe(expected) {
      const result = Object.is(input, expected)
      return isReversed ? !result : result
    },

    toEqual(expected) {
      const result = deepEqual(input, expected)
      return isReversed ? !result : result
    },

    toContain(item) {
      const result = Array.isArray(input) && input.includes(item)
      return isReversed ? !result : result
    },

    toBeGreaterThan(num) {
      const result = typeof input === 'number' && input > num
      return isReversed ? !result : result
    },

    toThrow() {
      let threw = false
      try {
        if (typeof input === 'function')
          input()
      }
      catch (e) {
        threw = true
      }
      return isReversed ? !threw : threw
    },
  }

  Object.defineProperty(matchers, 'not', {
    get() {
      isReversed = !isReversed
      return this
    },
  })

  return matchers
}

// æ·±åº¦ç›¸ç­‰æ¯”è¾ƒè¾…åŠ©å‡½æ•°
function deepEqual(a, b) {
  if (a === b)
    return true
  if (a == null || b == null)
    return false
  if (typeof a !== typeof b)
    return false

  if (typeof a === 'object') {
    const keysA = Object.keys(a)
    const keysB = Object.keys(b)
    if (keysA.length !== keysB.length)
      return false

    for (const key of keysA) {
      if (!keysB.includes(key))
        return false
      if (!deepEqual(a[key], b[key]))
        return false
    }
    return true
  }

  return false
}
```

### 3. æ”¯æŒå¼‚æ­¥æ–­è¨€

```javascript
function myExpectAsync(input) {
  let isReversed = false

  return {
    async toResolve() {
      try {
        await input
        return !isReversed
      }
      catch (e) {
        return isReversed
      }
    },

    async toReject() {
      try {
        await input
        return isReversed
      }
      catch (e) {
        return !isReversed
      }
    },

    get not() {
      isReversed = !isReversed
      return this
    },
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const promise1 = Promise.resolve(42)
const promise2 = Promise.reject('error')

console.log(await myExpectAsync(promise1).toResolve()) // true
console.log(await myExpectAsync(promise2).not.toResolve()) // true
```

### 4. å®Œæ•´çš„æµ‹è¯•æ¡†æ¶é›å½¢

```javascript
class TestSuite {
  constructor(name) {
    this.name = name
    this.tests = []
    this.results = []
  }

  test(description, testFn) {
    this.tests.push({ description, testFn })
  }

  async run() {
    console.log(`\n=== Running ${this.name} ===`)

    for (const { description, testFn } of this.tests) {
      try {
        await testFn()
        this.results.push({ description, status: 'PASS' })
        console.log(`âœ… ${description}`)
      }
      catch (error) {
        this.results.push({ description, status: 'FAIL', error })
        console.log(`âŒ ${description}: ${error.message}`)
      }
    }

    this.printSummary()
  }

  printSummary() {
    const passed = this.results.filter(r => r.status === 'PASS').length
    const total = this.results.length
    console.log(`\nğŸ“Š ${passed}/${total} tests passed\n`)
  }
}

// å¢å¼ºçš„ expect å‡½æ•°ï¼Œæ”¯æŒå¼‚å¸¸æŠ›å‡º
function expect(input) {
  let isReversed = false

  const expectObj = {
    toBe(expected) {
      const isEqual = Object.is(input, expected)
      const passed = isReversed ? !isEqual : isEqual

      if (!passed) {
        const message = isReversed
          ? `Expected ${input} not to be ${expected}`
          : `Expected ${input} to be ${expected}`
        throw new Error(message)
      }

      return passed
    },
  }

  Object.defineProperty(expectObj, 'not', {
    get() {
      isReversed = !isReversed
      return this
    },
  })

  return expectObj
}

// ä½¿ç”¨ç¤ºä¾‹
const suite = new TestSuite('My Math Tests')

suite.test('addition works', () => {
  expect(2 + 2).toBe(4)
})

suite.test('subtraction works', () => {
  expect(5 - 3).toBe(2)
})

suite.test('not equal works', () => {
  expect(1).not.toBe(2)
})

suite.run()
```

### 5. æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ç®¡ç†

```javascript
// å¯¹è±¡æ± æ¨¡å¼é¿å…é‡å¤åˆ›å»º
class ExpectObjectPool {
  constructor() {
    this.pool = []
  }

  get() {
    return this.pool.pop() || this.create()
  }

  release(obj) {
    obj.reset()
    this.pool.push(obj)
  }

  create() {
    return new ExpectObject()
  }
}

class ExpectObject {
  constructor() {
    this.reset()
  }

  reset() {
    this.input = undefined
    this.isReversed = false
  }

  init(input) {
    this.input = input
    return this
  }

  toBe(expected) {
    const isEqual = Object.is(this.input, expected)
    return this.isReversed ? !isEqual : isEqual
  }

  get not() {
    this.isReversed = !this.isReversed
    return this
  }
}

const pool = new ExpectObjectPool()

function myExpectPooled(input) {
  return pool.get().init(input)
}
```

## å¤ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£æµ‹è¯•æ¡†æ¶çš„åŸºæœ¬æ¦‚å¿µå’Œè®¾è®¡åŸç†
- [ ] æŒæ¡ Object.is() ä¸ === çš„åŒºåˆ«å’Œåº”ç”¨åœºæ™¯
- [ ] ç†Ÿç»ƒä½¿ç”¨ getter æ–¹æ³•å®ç°é“¾å¼è°ƒç”¨
- [ ] ç†è§£çŠ¶æ€ç®¡ç†å’Œä¿®é¥°ç¬¦çš„å®ç°æœºåˆ¶
- [ ] æŒæ¡é€»è¾‘åˆ¤æ–­çš„ç®€åŒ–å’Œä¼˜åŒ–æŠ€å·§
- [ ] èƒ½å¤Ÿæ‰©å±•æ”¯æŒæ›´å¤šåŒ¹é…å™¨å’Œæ–­è¨€æ–¹æ³•
- [ ] ç†è§£å¼‚æ­¥æµ‹è¯•å’Œé”™è¯¯å¤„ç†çš„å®ç°
- [ ] æŒæ¡é¿å…ç¡¬ç¼–ç çš„è®¾è®¡æ¨¡å¼
- [ ] äº†è§£æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ç®¡ç†æŠ€å·§
- [ ] èƒ½å¤Ÿè®¾è®¡å®Œæ•´çš„æµ‹è¯•æ¡†æ¶é›å½¢
