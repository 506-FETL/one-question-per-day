# Day 11 å¤ä¹ æ–‡æ¡£

## é¢˜ç›®æè¿°

å®ç° **Fiber æ ‘çš„å‰¯ä½œç”¨å¤„ç†**ï¼Œæ ¸å¿ƒè¦æ±‚ï¼š

- ç†è§£ Fiber æ¶æ„çš„é“¾è¡¨ç»“æ„ï¼ˆchildã€siblingã€returnï¼‰
- å®ç°æ·±åº¦ä¼˜å…ˆçš„æ ‘éå†ç®—æ³•
- æŒ‰ç…§æ­£ç¡®çš„é¡ºåºå¤„ç†èŠ‚ç‚¹çš„å‰¯ä½œç”¨
- æ¨¡æ‹Ÿ React ä¸­çš„ commit é˜¶æ®µå¤„ç†

æœ¬é¢˜è€ƒæŸ¥ **æ ‘éå†ç®—æ³•**ã€**é“¾è¡¨æ“ä½œ** å’Œ **React Fiber æ¶æ„** çš„æ·±åº¦ç†è§£ã€‚

## æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. Fiber æ¶æ„çš„é“¾è¡¨ç»“æ„

```javascript
// ä¼ ç»Ÿæ ‘ç»“æ„ vs Fiberé“¾è¡¨ç»“æ„
// ä¼ ç»Ÿæ ‘ï¼š        Fiberé“¾è¡¨ï¼š
//     A              A
//   / | \           /
//  B  C  D    =>   B - C - D
//    /             /
//   E             E
```

**Fiber èŠ‚ç‚¹ä¸‰ä¸ªå…³é”®æŒ‡é’ˆ**ï¼š

- `child`: æŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
- `sibling`: æŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
- `return`: æŒ‡å‘çˆ¶èŠ‚ç‚¹ï¼ˆå‘ä¸Šå›æº¯ç”¨ï¼‰

### 2. Fiber æ¶æ„çš„ä¼˜åŠ¿

- **å¯ä¸­æ–­éå†**: å¯ä»¥æš‚åœå’Œæ¢å¤éå†è¿‡ç¨‹
- **ä¼˜å…ˆçº§è°ƒåº¦**: æ”¯æŒä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡è°ƒåº¦
- **å¢é‡æ›´æ–°**: å°†å·¥ä½œåˆ†ç‰‡ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡ä¸»çº¿ç¨‹
- **åŒç¼“å†²**: current æ ‘å’Œ workInProgress æ ‘åˆ‡æ¢

### 3. React Commit é˜¶æ®µçš„å¤„ç†é¡ºåº

```javascript
// 1. commitBeforeMutationEffects (DOM å˜æ›´å‰)
// 2. commitMutationEffects (DOM å˜æ›´)
// 3. commitLayoutEffects (DOM å˜æ›´å)

// æ¯ä¸ªé˜¶æ®µéƒ½éœ€è¦æ·±åº¦ä¼˜å…ˆéå†æ•´ä¸ª Fiber æ ‘
```

### 4. æ·±åº¦ä¼˜å…ˆéå†çš„å…³é”®ç‚¹

- **å…ˆå­åå…„**: ä¼˜å…ˆå¤„ç†å­èŠ‚ç‚¹ï¼Œå†å¤„ç†å…„å¼ŸèŠ‚ç‚¹
- **å›æº¯æœºåˆ¶**: åˆ©ç”¨ return æŒ‡é’ˆå‘ä¸Šå›æº¯
- **å®Œæ•´éå†**: ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹éƒ½è¢«è®¿é—®åˆ°

## ä»£ç å®ç°

```javascript
/**
 * Fiber èŠ‚ç‚¹ç±»å‹å®šä¹‰
 */
class FiberNode {
  constructor(tag, key = null) {
    this.tag = tag // èŠ‚ç‚¹æ ‡è¯†
    this.key = key // React key
    this.child = null // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
    this.sibling = null // ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
    this.return = null // çˆ¶èŠ‚ç‚¹
    this.effects = [] // å‰¯ä½œç”¨åˆ—è¡¨
    this.effectTag = null // å‰¯ä½œç”¨ç±»å‹
  }
}

/**
 * åŸºç¡€å®ç°ï¼šFiber æ ‘çš„æ·±åº¦ä¼˜å…ˆéå†
 * æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œç©ºé—´å¤æ‚åº¦ï¼šO(1)
 */
function commitNestedComponent(root, onCommitUnmount) {
  if (!root) return

  let current = root

  while (current) {
    // å¤„ç†å½“å‰èŠ‚ç‚¹
    onCommitUnmount(current)

    // æ·±åº¦ä¼˜å…ˆéå†ç­–ç•¥
    if (current.child) {
      // 1. ä¼˜å…ˆå¤„ç†å­èŠ‚ç‚¹
      current = current.child
    } else if (current.sibling) {
      // 2. æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œå¤„ç†å…„å¼ŸèŠ‚ç‚¹
      current = current.sibling
    } else {
      // 3. æ²¡æœ‰å­èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹ï¼Œå‘ä¸Šå›æº¯
      current = current.return

      // æŸ¥æ‰¾æœªå¤„ç†çš„å…„å¼ŸèŠ‚ç‚¹
      while (current && !current.sibling) {
        current = current.return
      }

      // ç»§ç»­å¤„ç†å…„å¼ŸèŠ‚ç‚¹
      if (current) {
        current = current.sibling
      }
    }
  }
}

/**
 * å¢å¼ºç‰ˆå®ç°ï¼šæ”¯æŒå‰¯ä½œç”¨æ”¶é›†å’Œå¤„ç†
 */
function commitWithEffects(root, onCommitUnmount) {
  const effectList = []

  function traverseAndCollect(fiber) {
    if (!fiber) return

    // æ”¶é›†æœ‰å‰¯ä½œç”¨çš„èŠ‚ç‚¹
    if (fiber.effectTag) {
      effectList.push(fiber)
    }

    // æ·±åº¦ä¼˜å…ˆéå†
    let current = fiber
    while (current) {
      // å¤„ç†å½“å‰èŠ‚ç‚¹
      onCommitUnmount(current)

      if (current.child) {
        current = current.child
      } else if (current.sibling) {
        current = current.sibling
      } else {
        // å›æº¯åˆ°æœ‰å…„å¼ŸèŠ‚ç‚¹çš„ç¥–å…ˆ
        current = current.return
        while (current && current !== fiber && !current.sibling) {
          current = current.return
        }

        if (current && current !== fiber) {
          current = current.sibling
        } else {
          break
        }
      }
    }
  }

  traverseAndCollect(root)

  // å¤„ç†æ”¶é›†åˆ°çš„å‰¯ä½œç”¨
  effectList.forEach((fiber) => {
    console.log(`Processing effect: ${fiber.effectTag} on ${fiber.tag}`)
  })

  return effectList
}

/**
 * é€’å½’ç‰ˆæœ¬å®ç°ï¼ˆæ›´å®¹æ˜“ç†è§£ï¼‰
 */
function commitNestedComponentRecursive(root, onCommitUnmount) {
  if (!root) return

  // å¤„ç†å½“å‰èŠ‚ç‚¹
  onCommitUnmount(root)

  // é€’å½’å¤„ç†å­æ ‘
  let child = root.child
  while (child) {
    commitNestedComponentRecursive(child, onCommitUnmount)
    child = child.sibling
  }
}

/**
 * æ”¯æŒä¸­æ–­çš„å¯æ¢å¤éå†
 */
class FiberTraverser {
  constructor(root) {
    this.root = root
    this.current = root
    this.isComplete = false
    this.visited = new Set()
  }

  // æ‰§è¡Œä¸€æ­¥éå†
  step(onCommitUnmount, shouldContinue = () => true) {
    if (this.isComplete || !this.current) {
      return false
    }

    const startTime = performance.now()

    while (this.current && shouldContinue()) {
      // é¿å…é‡å¤å¤„ç†
      if (!this.visited.has(this.current)) {
        onCommitUnmount(this.current)
        this.visited.add(this.current)
      }

      // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
      if (this.current.child && !this.visited.has(this.current.child)) {
        this.current = this.current.child
      } else if (this.current.sibling) {
        this.current = this.current.sibling
      } else {
        // å›æº¯
        this.current = this.current.return
        while (this.current && !this.current.sibling) {
          this.current = this.current.return
        }

        if (this.current) {
          this.current = this.current.sibling
        } else {
          this.isComplete = true
          break
        }
      }

      // é˜²æ­¢é•¿æ—¶é—´é˜»å¡
      if (performance.now() - startTime > 5) {
        break
      }
    }

    return !this.isComplete
  }

  // å®Œæ•´éå†
  traverse(onCommitUnmount) {
    while (this.step(onCommitUnmount)) {
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è°ƒåº¦é€»è¾‘
    }
  }
}

/**
 * æ¨¡æ‹Ÿ React çš„ commit é˜¶æ®µ
 */
function simulateReactCommit(root) {
  const phases = ['beforeMutation', 'mutation', 'layout']

  phases.forEach((phase) => {
    console.log(`Starting ${phase} phase`)

    commitNestedComponent(root, (fiber) => {
      if (fiber.effects.includes(phase)) {
        console.log(`${phase}: processing ${fiber.tag}`)
      }
    })

    console.log(`Completed ${phase} phase`)
  })
}

/**
 * æ”¯æŒä¼˜å…ˆçº§çš„å‰¯ä½œç”¨å¤„ç†
 */
function commitWithPriority(root, onCommitUnmount) {
  const highPriorityNodes = []
  const normalPriorityNodes = []
  const lowPriorityNodes = []

  // æ”¶é›†å¹¶åˆ†ç±»èŠ‚ç‚¹
  commitNestedComponent(root, (fiber) => {
    if (fiber.priority === 'high') {
      highPriorityNodes.push(fiber)
    } else if (fiber.priority === 'low') {
      lowPriorityNodes.push(fiber)
    } else {
      normalPriorityNodes.push(fiber)
    }
  })

  // æŒ‰ä¼˜å…ˆçº§å¤„ç†
  const processNodes = (nodes, priority) => {
    console.log(`Processing ${priority} priority nodes`)
    nodes.forEach(onCommitUnmount)
  }

  processNodes(highPriorityNodes, 'high')
  processNodes(normalPriorityNodes, 'normal')
  processNodes(lowPriorityNodes, 'low')
}

/**
 * æ”¯æŒé”™è¯¯è¾¹ç•Œçš„éå†
 */
function commitWithErrorHandling(root, onCommitUnmount, onError) {
  let current = root
  const errorStack = []

  while (current) {
    try {
      onCommitUnmount(current)

      if (current.child) {
        errorStack.push(current) // è®°å½•è·¯å¾„ç”¨äºé”™è¯¯æ¢å¤
        current = current.child
      } else if (current.sibling) {
        current = current.sibling
      } else {
        // å›æº¯
        errorStack.pop()
        current = current.return

        while (current && !current.sibling) {
          errorStack.pop()
          current = current.return
        }

        if (current) {
          current = current.sibling
        }
      }
    } catch (error) {
      console.error(`Error processing fiber node ${current.tag}:`, error)

      if (onError) {
        const shouldContinue = onError(error, current, errorStack)
        if (!shouldContinue) {
          break
        }
      }

      // è·³è¿‡å½“å‰èŠ‚ç‚¹ï¼Œç»§ç»­å¤„ç†
      if (current.sibling) {
        current = current.sibling
      } else {
        // å›æº¯åˆ°å®‰å…¨ä½ç½®
        current = errorStack.pop()?.return
        while (current && !current.sibling) {
          current = current.return
        }

        if (current) {
          current = current.sibling
        }
      }
    }
  }
}
```

## ç®—æ³•åˆ†æ

- **æ—¶é—´å¤æ‚åº¦**: O(n) - n ä¸º Fiber æ ‘ä¸­èŠ‚ç‚¹çš„æ€»æ•°
- **ç©ºé—´å¤æ‚åº¦**: O(1) - è¿­ä»£ç‰ˆæœ¬ï¼ŒO(h) - é€’å½’ç‰ˆæœ¬(hä¸ºæ ‘é«˜)
- **ç‰¹ç‚¹**: æ·±åº¦ä¼˜å…ˆéå†ã€é“¾è¡¨æ“ä½œã€å¯ä¸­æ–­æ‰§è¡Œ

## å…³é”®æŠ€æœ¯ç‚¹

### 1. Fiber é“¾è¡¨ç»“æ„éå†

```javascript
// æ ¸å¿ƒéå†é€»è¾‘
while (current) {
  // å¤„ç†å½“å‰èŠ‚ç‚¹
  process(current)

  // ä¼˜å…ˆå¤„ç†å­èŠ‚ç‚¹
  if (current.child) {
    current = current.child
  }
  // å…¶æ¬¡å¤„ç†å…„å¼ŸèŠ‚ç‚¹
  else if (current.sibling) {
    current = current.sibling
  }
  // æœ€åå›æº¯åˆ°çˆ¶èŠ‚ç‚¹
  else {
    current = findNextSibling(current)
  }
}
```

### 2. å›æº¯ç®—æ³•çš„å…³é”®

```javascript
// å‘ä¸Šå›æº¯ç›´åˆ°æ‰¾åˆ°æœ‰å…„å¼ŸèŠ‚ç‚¹çš„ç¥–å…ˆ
function findNextSibling(node) {
  let current = node.return

  while (current && !current.sibling) {
    current = current.return
  }

  return current ? current.sibling : null
}
```

### 3. React Fiber çš„ä¸‰ä¸ªé˜¶æ®µ

```javascript
// 1. beforeMutation é˜¶æ®µï¼šDOM å˜æ›´å‰
//    - æ‰§è¡Œ getSnapshotBeforeUpdate
//    - è°ƒåº¦ useEffect

// 2. mutation é˜¶æ®µï¼šDOM å˜æ›´
//    - æ ¹æ® effectTag æ‰§è¡Œ DOM æ“ä½œ
//    - æ’å…¥ã€æ›´æ–°ã€åˆ é™¤èŠ‚ç‚¹

// 3. layout é˜¶æ®µï¼šDOM å˜æ›´å
//    - æ‰§è¡Œ useLayoutEffect
//    - è°ƒç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
```

### 4. å¯ä¸­æ–­æ‰§è¡Œçš„å®ç°

```javascript
function interruptibleTraverse(root, onCommit) {
  let current = root

  return function step() {
    const startTime = performance.now()

    while (current && performance.now() - startTime < 5) {
      onCommit(current)
      current = getNextNode(current)
    }

    return current !== null // è¿”å›æ˜¯å¦è¿˜æœ‰æœªå¤„ç†çš„èŠ‚ç‚¹
  }
}
```

### 5. å¸¸è§é™·é˜±å’Œå‘ç‚¹

- **æ— é™å¾ªç¯**: å›æº¯é€»è¾‘é”™è¯¯å¯¼è‡´çš„å¾ªç¯
- **èŠ‚ç‚¹é—æ¼**: å…„å¼ŸèŠ‚ç‚¹é“¾å¤„ç†ä¸å½“
- **å†…å­˜æ³„æ¼**: é•¿æ—¶é—´æŒæœ‰ Fiber èŠ‚ç‚¹å¼•ç”¨
- **é¡ºåºé”™è¯¯**: æ²¡æœ‰æŒ‰ç…§æ­£ç¡®çš„æ·±åº¦ä¼˜å…ˆé¡ºåº
- **å¼‚å¸¸å¤„ç†**: èŠ‚ç‚¹å¤„ç†å¤±è´¥æ—¶çš„æ¢å¤æœºåˆ¶

## ä½¿ç”¨ç¤ºä¾‹

```javascript
// æ„å»º Fiber æ ‘ç¤ºä¾‹
//       A
//      /
//     B - C - D
//    /       /
//   E - F   G

function createFiberTree() {
  const A = new FiberNode('A')
  const B = new FiberNode('B')
  const C = new FiberNode('C')
  const D = new FiberNode('D')
  const E = new FiberNode('E')
  const F = new FiberNode('F')
  const G = new FiberNode('G')

  // è®¾ç½®çˆ¶å­å…³ç³»
  A.child = B
  B.child = E
  E.sibling = F

  // è®¾ç½®å…„å¼Ÿå…³ç³»
  B.sibling = C
  C.sibling = D
  D.child = G

  // è®¾ç½® return æŒ‡é’ˆ
  B.return = A
  C.return = A
  D.return = A
  E.return = B
  F.return = B
  G.return = D

  return A
}

// åŸºæœ¬éå†ç¤ºä¾‹
const root = createFiberTree()
const visitOrder = []

commitNestedComponent(root, (fiber) => {
  visitOrder.push(fiber.tag)
  console.log(`Visiting: ${fiber.tag}`)
})

console.log('Visit order:', visitOrder)
// è¾“å‡º: ['A', 'B', 'E', 'F', 'C', 'D', 'G']

// å‰¯ä½œç”¨å¤„ç†ç¤ºä¾‹
function setupEffects(root) {
  // ä¸ºèŠ‚ç‚¹æ·»åŠ å‰¯ä½œç”¨
  root.effectTag = 'UPDATE'
  root.child.effectTag = 'INSERT'
  root.child.sibling.effectTag = 'DELETE'

  return root
}

const rootWithEffects = setupEffects(createFiberTree())
const effects = commitWithEffects(rootWithEffects, (fiber) => {
  if (fiber.effectTag) {
    console.log(`Effect: ${fiber.effectTag} on ${fiber.tag}`)
  }
})

// å¯ä¸­æ–­éå†ç¤ºä¾‹
const traverser = new FiberTraverser(createFiberTree())
let stepCount = 0

// æ¨¡æ‹Ÿæ—¶é—´åˆ‡ç‰‡
function timeSlicedTraversal() {
  const hasMore = traverser.step(
    (fiber) => {
      console.log(`Step ${++stepCount}: ${fiber.tag}`)
    },
    () => performance.now() % 10 < 5,
  ) // 50% æ¦‚ç‡ç»§ç»­

  if (hasMore) {
    setTimeout(timeSlicedTraversal, 16) // ä¸‹ä¸€å¸§ç»§ç»­
  } else {
    console.log('Traversal complete')
  }
}

timeSlicedTraversal()

// é”™è¯¯å¤„ç†ç¤ºä¾‹
const problematicRoot = createFiberTree()
problematicRoot.child.sibling.tag = null // åˆ¶é€ é”™è¯¯

commitWithErrorHandling(
  problematicRoot,
  (fiber) => {
    if (!fiber.tag) {
      throw new Error('Invalid fiber node')
    }
    console.log(`Processing: ${fiber.tag}`)
  },
  (error, fiber, stack) => {
    console.error(`Error at ${fiber?.tag || 'unknown'}:`, error.message)
    console.log(
      'Error stack:',
      stack.map((f) => f.tag),
    )
    return true // ç»§ç»­æ‰§è¡Œ
  },
)

// ä¼˜å…ˆçº§å¤„ç†ç¤ºä¾‹
function setPriorities(root) {
  root.priority = 'high'
  root.child.priority = 'normal'
  root.child.sibling.priority = 'low'
  root.child.child.priority = 'high'

  return root
}

const prioritizedRoot = setPriorities(createFiberTree())
commitWithPriority(prioritizedRoot, (fiber) => {
  console.log(`Processing ${fiber.priority} priority: ${fiber.tag}`)
})

// æ€§èƒ½æµ‹è¯•
function performanceTest() {
  // åˆ›å»ºå¤§å‹ Fiber æ ‘
  function createLargeFiberTree(depth, breadth) {
    const root = new FiberNode(`node-0`)

    function buildLevel(parent, currentDepth, nodeIndex) {
      if (currentDepth >= depth) return nodeIndex

      let prevSibling = null
      for (let i = 0; i < breadth; i++) {
        const node = new FiberNode(`node-${nodeIndex++}`)
        node.return = parent

        if (i === 0) {
          parent.child = node
        } else {
          prevSibling.sibling = node
        }

        nodeIndex = buildLevel(node, currentDepth + 1, nodeIndex)
        prevSibling = node
      }

      return nodeIndex
    }

    buildLevel(root, 0, 1)
    return root
  }

  const largeTree = createLargeFiberTree(6, 3) // æ·±åº¦6ï¼Œæ¯å±‚3ä¸ªèŠ‚ç‚¹
  let nodeCount = 0

  console.time('Fiber traversal')
  commitNestedComponent(largeTree, () => {
    nodeCount++
  })
  console.timeEnd('Fiber traversal')

  console.log(`Processed ${nodeCount} nodes`)
}

performanceTest()

// ä¸ä¼ ç»Ÿæ ‘éå†å¯¹æ¯”
function traditionalTreeTraversal(node, visit) {
  if (!node) return

  visit(node)

  // å‡è®¾ä¼ ç»Ÿæ ‘æœ‰ children æ•°ç»„
  if (node.children) {
    node.children.forEach((child) => {
      traditionalTreeTraversal(child, visit)
    })
  }
}

// æ¨¡æ‹Ÿ React ç»„ä»¶æ ‘
function createReactComponentTree() {
  const App = new FiberNode('App')
  const Header = new FiberNode('Header')
  const Main = new FiberNode('Main')
  const Footer = new FiberNode('Footer')
  const Nav = new FiberNode('Nav')
  const Content = new FiberNode('Content')

  App.child = Header
  Header.sibling = Main
  Main.sibling = Footer

  Header.child = Nav
  Main.child = Content

  // è®¾ç½® return æŒ‡é’ˆ
  Header.return = App
  Main.return = App
  Footer.return = App
  Nav.return = Header
  Content.return = Main

  return App
}

const componentTree = createReactComponentTree()
console.log('React component tree traversal:')
commitNestedComponent(componentTree, (fiber) => {
  console.log(`Rendering component: ${fiber.tag}`)
})
```

## è®°å¿†è¦ç‚¹

### æ ¸å¿ƒè®°å¿†ç‚¹

1. **ä¸‰æŒ‡é’ˆç»“æ„** - child(å­)ã€sibling(å…„)ã€return(çˆ¶)
2. **æ·±åº¦ä¼˜å…ˆ** - å…ˆå­èŠ‚ç‚¹ã€å†å…„å¼ŸèŠ‚ç‚¹ã€æœ€åå›æº¯
3. **è¿­ä»£å®ç°** - é¿å…é€’å½’æ ˆæº¢å‡ºï¼Œæ”¯æŒä¸­æ–­
4. **å›æº¯ç®—æ³•** - å‘ä¸ŠæŸ¥æ‰¾æœªå¤„ç†çš„å…„å¼ŸèŠ‚ç‚¹
5. **å‰¯ä½œç”¨æ”¶é›†** - éå†è¿‡ç¨‹ä¸­æ”¶é›†éœ€è¦å¤„ç†çš„å‰¯ä½œç”¨

### éå†é¡ºåºè®°å¿†

```javascript
// éå†ä¼˜å…ˆçº§ï¼šchild > sibling > return
// 1. æœ‰å­èŠ‚ç‚¹ -> è¿›å…¥å­èŠ‚ç‚¹
// 2. æ— å­èŠ‚ç‚¹æœ‰å…„å¼Ÿ -> è¿›å…¥å…„å¼ŸèŠ‚ç‚¹
// 3. æ— å­æ— å…„å¼Ÿ -> å›æº¯åˆ°çˆ¶èŠ‚ç‚¹
// 4. é‡å¤ç›´åˆ°å›æº¯åˆ°æ ¹èŠ‚ç‚¹ä¸”æ— å…„å¼ŸèŠ‚ç‚¹
```

## æ‰©å±•æ€è€ƒ

### 1. æ”¯æŒæ¡ä»¶éå†

```javascript
function conditionalCommit(root, shouldVisit, onCommit) {
  let current = root

  while (current) {
    if (shouldVisit(current)) {
      onCommit(current)
    }

    // æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦éå†å­æ ‘
    if (current.child && shouldVisit(current)) {
      current = current.child
    } else if (current.sibling) {
      current = current.sibling
    } else {
      current = findNextSiblingFromAncestor(current)
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šåªå¤„ç†ç‰¹å®šç±»å‹çš„ç»„ä»¶
conditionalCommit(
  root,
  (fiber) => fiber.tag.startsWith('User'), // åªå¤„ç†ç”¨æˆ·ç»„ä»¶
  (fiber) => console.log(`Processing user component: ${fiber.tag}`),
)
```

### 2. æ”¯æŒå¹¶è¡Œå¤„ç†

```javascript
async function parallelCommit(root, onCommit, concurrency = 4) {
  const queue = []
  const workers = []

  // æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹
  commitNestedComponent(root, (fiber) => {
    queue.push(fiber)
  })

  // åˆ›å»ºå·¥ä½œå™¨
  for (let i = 0; i < concurrency; i++) {
    workers.push(processQueue())
  }

  async function processQueue() {
    while (queue.length > 0) {
      const fiber = queue.shift()
      if (fiber) {
        await onCommit(fiber)
      }
    }
  }

  await Promise.all(workers)
}
```

### 3. æ”¯æŒ Diff ç®—æ³•

```javascript
function commitWithDiff(oldRoot, newRoot, onUpdate) {
  const oldNodes = new Map()
  const newNodes = new Map()

  // æ”¶é›†æ—§æ ‘èŠ‚ç‚¹
  commitNestedComponent(oldRoot, (fiber) => {
    oldNodes.set(fiber.key || fiber.tag, fiber)
  })

  // æ”¶é›†æ–°æ ‘èŠ‚ç‚¹å¹¶è¿›è¡Œå¯¹æ¯”
  commitNestedComponent(newRoot, (fiber) => {
    const key = fiber.key || fiber.tag
    const oldFiber = oldNodes.get(key)

    if (!oldFiber) {
      onUpdate('INSERT', fiber, null)
    } else if (hasChanged(oldFiber, fiber)) {
      onUpdate('UPDATE', fiber, oldFiber)
    }

    newNodes.set(key, fiber)
    oldNodes.delete(key)
  })

  // å¤„ç†åˆ é™¤çš„èŠ‚ç‚¹
  for (const [key, fiber] of oldNodes) {
    onUpdate('DELETE', null, fiber)
  }
}
```

### 4. æ”¯æŒæ—¶é—´åˆ‡ç‰‡è°ƒåº¦

```javascript
class FiberScheduler {
  constructor() {
    this.taskQueue = []
    this.isRunning = false
    this.frameDeadline = 0
  }

  schedule(root, onCommit, priority = 'normal') {
    const task = {
      root,
      onCommit,
      priority,
      traverser: new FiberTraverser(root),
    }

    this.taskQueue.push(task)
    this.taskQueue.sort(
      (a, b) => this.getPriorityValue(b.priority) - this.getPriorityValue(a.priority),
    )

    if (!this.isRunning) {
      this.scheduleWork()
    }
  }

  scheduleWork() {
    this.isRunning = true
    requestIdleCallback(this.performWork.bind(this))
  }

  performWork(deadline) {
    this.frameDeadline = deadline.timeRemaining()

    while (this.taskQueue.length > 0 && this.frameDeadline > 1) {
      const task = this.taskQueue[0]

      const hasMore = task.traverser.step(task.onCommit, () => this.frameDeadline > 1)

      if (!hasMore) {
        this.taskQueue.shift() // ä»»åŠ¡å®Œæˆ
      }

      this.frameDeadline = deadline.timeRemaining()
    }

    if (this.taskQueue.length > 0) {
      this.scheduleWork() // ç»§ç»­è°ƒåº¦
    } else {
      this.isRunning = false
    }
  }

  getPriorityValue(priority) {
    const priorities = { immediate: 3, high: 2, normal: 1, low: 0 }
    return priorities[priority] || 1
  }
}
```

### 5. æ”¯æŒå‰¯ä½œç”¨é“¾ä¼˜åŒ–

```javascript
function buildEffectList(root) {
  let firstEffect = null
  let lastEffect = null

  function appendEffect(fiber) {
    if (!firstEffect) {
      firstEffect = lastEffect = fiber
    } else {
      lastEffect.nextEffect = fiber
      lastEffect = fiber
    }
    fiber.nextEffect = null
  }

  function collectEffects(fiber) {
    let childEffect = null

    // æ”¶é›†å­æ ‘çš„å‰¯ä½œç”¨
    let child = fiber.child
    while (child) {
      const effect = collectEffects(child)
      if (effect) {
        if (!childEffect) {
          childEffect = effect
        }
      }
      child = child.sibling
    }

    // æ·»åŠ å½“å‰èŠ‚ç‚¹çš„å‰¯ä½œç”¨
    if (fiber.effectTag) {
      appendEffect(fiber)
    }

    return firstEffect
  }

  return collectEffects(root)
}

// ä½¿ç”¨ä¼˜åŒ–çš„å‰¯ä½œç”¨é“¾
function commitEffectList(firstEffect, onCommit) {
  let effect = firstEffect

  while (effect) {
    onCommit(effect)
    effect = effect.nextEffect
  }
}
```

## å¤ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ Fiber æ¶æ„çš„é“¾è¡¨ç»“æ„å’Œä¼˜åŠ¿
- [ ] æŒæ¡æ·±åº¦ä¼˜å…ˆéå†çš„è¿­ä»£å®ç°
- [ ] ç†Ÿç»ƒä½¿ç”¨ä¸‰æŒ‡é’ˆ(child/sibling/return)å¯¼èˆª
- [ ] ç†è§£å›æº¯ç®—æ³•åœ¨æ ‘éå†ä¸­çš„åº”ç”¨
- [ ] æŒæ¡å¯ä¸­æ–­éå†çš„å®ç°åŸç†
- [ ] äº†è§£ React Fiber çš„å·¥ä½œåŸç†
- [ ] èƒ½å¤Ÿå¤„ç†å‰¯ä½œç”¨æ”¶é›†å’Œå¤„ç†
- [ ] ç†Ÿæ‚‰é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
- [ ] ç†è§£æ—¶é—´åˆ‡ç‰‡å’Œä¼˜å…ˆçº§è°ƒåº¦
- [ ] æŒæ¡æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ç®¡ç†æŠ€å·§
- **å†å¤„ç†å…„å¼Ÿ**ï¼šæ— å­èŠ‚ç‚¹æ—¶å¤„ç†å…„å¼ŸèŠ‚ç‚¹
- **å›æº¯çˆ¶èŠ‚ç‚¹**ï¼šæ— å…„å¼Ÿæ—¶å›æº¯åˆ°çˆ¶èŠ‚ç‚¹

## ğŸ’» å®ç°ä»£ç 

```javascript
export function commitNestedComponent(root, onCommitUnmount) {
  // æ·±åº¦ä¼˜å…ˆéå†æ•´ä¸ªå­æ ‘
  let node = root

  // ä½¿ç”¨å¾ªç¯ä»£æ›¿é€’å½’ï¼Œéµå¾ª Fiber æ ‘çš„ç‰¹æ®Šéå†æ–¹å¼
  while (node !== null) {
    // å¯¹å½“å‰èŠ‚ç‚¹æ‰§è¡Œå¸è½½å›è°ƒ
    onCommitUnmount(node)

    // å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œå…ˆå¤„ç†å­èŠ‚ç‚¹
    if (node.child !== null) {
      node = node.child
      continue
    }

    // å¦‚æœå·²ç»åˆ°è¾¾æ ¹èŠ‚ç‚¹çš„æœ€æ·±å¤„ï¼Œå¼€å§‹å›æº¯
    if (node === root) {
      return
    }

    // æ²¡æœ‰å­èŠ‚ç‚¹äº†ï¼Œå¤„ç†å…„å¼ŸèŠ‚ç‚¹
    while (node.sibling === null) {
      // å¦‚æœæ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œè¿”å›çˆ¶èŠ‚ç‚¹
      if (node.return === null || node.return === root) {
        return
      }
      node = node.return
    }

    // å¤„ç†ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
    node = node.sibling
  }
}
```

## ğŸ§  ç®—æ³•åˆ†æ

### æ ¸å¿ƒæ€è·¯

1. **å¾ªç¯éå†**ï¼šä½¿ç”¨ while å¾ªç¯æ›¿ä»£é€’å½’ï¼Œé¿å…æ ˆæº¢å‡º
2. **ä¸‰é‡åˆ¤æ–­**ï¼šä¾æ¬¡æ£€æŸ¥å­èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹ã€çˆ¶èŠ‚ç‚¹
3. **å›æº¯æœºåˆ¶**ï¼šæ— å­èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹æ—¶å‘ä¸Šå›æº¯
4. **è¾¹ç•Œå¤„ç†**ï¼šåˆ°è¾¾æ ¹èŠ‚ç‚¹æ—¶ç»ˆæ­¢éå†

### éå†é¡ºåº

```
A â†’ B â†’ D â†’ E â†’ C
1. å¤„ç† Aï¼Œè¿›å…¥å­èŠ‚ç‚¹ B
2. å¤„ç† Bï¼Œè¿›å…¥å­èŠ‚ç‚¹ D
3. å¤„ç† Dï¼Œæ— å­èŠ‚ç‚¹ï¼Œå¤„ç†å…„å¼Ÿ E
4. å¤„ç† Eï¼Œæ— å­èŠ‚ç‚¹å’Œå…„å¼Ÿï¼Œå›æº¯åˆ° B
5. B çš„å…„å¼Ÿæ˜¯ Cï¼Œå¤„ç† C
6. C æ— å­èŠ‚ç‚¹å’Œå…„å¼Ÿï¼Œå›æº¯åˆ° Aï¼ˆæ ¹èŠ‚ç‚¹ï¼‰ï¼Œç»“æŸ
```

### æ—¶é—´å¤æ‚åº¦

- **O(n)**ï¼šæ¯ä¸ªèŠ‚ç‚¹è®¿é—®ä¸€æ¬¡ï¼Œn ä¸ºèŠ‚ç‚¹æ€»æ•°

### ç©ºé—´å¤æ‚åº¦

- **O(1)**ï¼šåªä½¿ç”¨å¸¸æ•°çº§åˆ«çš„é¢å¤–ç©ºé—´ï¼Œæ— é€’å½’è°ƒç”¨æ ˆ

## ğŸ” å…³é”®æŠ€æœ¯ç‚¹

### 1. å­èŠ‚ç‚¹ä¼˜å…ˆç­–ç•¥

```javascript
if (node.child !== null) {
  node = node.child
  continue  // ç«‹å³å¤„ç†å­èŠ‚ç‚¹
}
```

### 2. æ ¹èŠ‚ç‚¹è¾¹ç•Œæ£€æŸ¥

```javascript
if (node === root) {
  return // éå†å®Œæˆï¼Œé˜²æ­¢è¶Šç•Œ
}
```

### 3. å…„å¼ŸèŠ‚ç‚¹å›æº¯é€»è¾‘

```javascript
while (node.sibling === null) {
  if (node.return === null || node.return === root) {
    return // å·²åˆ°è¾¾è¾¹ç•Œ
  }
  node = node.return // å‘ä¸Šå›æº¯
}
node = node.sibling // å¤„ç†å…„å¼ŸèŠ‚ç‚¹
```

### 4. å¾ªç¯æ›¿ä»£é€’å½’

- **é¿å…æ ˆæº¢å‡º**ï¼šæ·±å±‚åµŒå¥—æ—¶ä¸ä¼šå¯¼è‡´è°ƒç”¨æ ˆæº¢å‡º
- **å†…å­˜æ•ˆç‡**ï¼šO(1) ç©ºé—´å¤æ‚åº¦
- **å¯ä¸­æ–­æ€§**ï¼šä¾¿äºå®ç°æ—¶é—´åˆ‡ç‰‡

## ğŸ§ª ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ Fiber æ ‘

```javascript
class FiberNode {
  constructor(value) {
    this.value = value
    this.child = null
    this.sibling = null
    this.return = null
  }
}

// æ„å»º Fiber æ ‘
const A = new FiberNode('A')
const B = new FiberNode('B')
const C = new FiberNode('C')
const D = new FiberNode('D')
const E = new FiberNode('E')

// å»ºç«‹å…³ç³»
A.child = B
B.sibling = C
B.child = D
D.sibling = E

// è®¾ç½® return æŒ‡é’ˆ
B.return = A
C.return = A
D.return = B
E.return = B
```

### éå†æ‰§è¡Œ

```javascript
const results = []
commitNestedComponent(A, (node) => {
  results.push(node.value)
})

console.log(results) // ['A', 'B', 'D', 'E', 'C']
```

### å¤æ‚æ ‘ç»“æ„

```javascript
//       A
//      / \
//     B   C
//    /   / \
//   D   E   F
//  /
// G

// éå†é¡ºåºï¼šA â†’ B â†’ D â†’ G â†’ C â†’ E â†’ F
```

## ğŸ’¡ å…³é”®è®°å¿†ç‚¹

1. **Fiber ä¸‰æŒ‡é’ˆ**ï¼šchildï¼ˆå­ï¼‰ã€siblingï¼ˆå…„å¼Ÿï¼‰ã€returnï¼ˆçˆ¶ï¼‰
2. **éå†ä¼˜å…ˆçº§**ï¼šå­èŠ‚ç‚¹ > å…„å¼ŸèŠ‚ç‚¹ > çˆ¶èŠ‚ç‚¹å›æº¯
3. **å¾ªç¯éå†**ï¼šç”¨å¾ªç¯æ›¿ä»£é€’å½’ï¼Œç©ºé—´å¤æ‚åº¦ O(1)
4. **è¾¹ç•Œæ£€æŸ¥**ï¼šæ ¹èŠ‚ç‚¹ä½œä¸ºéå†ç»ˆæ­¢æ¡ä»¶
5. **å›æº¯é€»è¾‘**ï¼šæ— å…„å¼ŸèŠ‚ç‚¹æ—¶å‘ä¸Šå›æº¯ç›´åˆ°æ‰¾åˆ°å…„å¼Ÿæˆ–æ ¹èŠ‚ç‚¹
6. **æ·±åº¦ä¼˜å…ˆ**ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¢«è®¿é—®ä¸”åªè®¿é—®ä¸€æ¬¡

## ğŸ¤” æ‰©å±•æ€è€ƒ

### ä¸ä¼ ç»Ÿæ ‘éå†çš„å·®å¼‚

- **ä¼ ç»Ÿé€’å½’**ï¼šä½¿ç”¨å‡½æ•°è°ƒç”¨æ ˆï¼Œç©ºé—´å¤æ‚åº¦ O(h)
- **Fiber å¾ªç¯**ï¼šä½¿ç”¨æŒ‡é’ˆéå†ï¼Œç©ºé—´å¤æ‚åº¦ O(1)
- **å¯ä¸­æ–­æ€§**ï¼šFiber éå†å¯ä»¥éšæ—¶æš‚åœå’Œæ¢å¤

### React Fiber çš„å®é™…åº”ç”¨

- **æ—¶é—´åˆ‡ç‰‡**ï¼šå°†æ¸²æŸ“å·¥ä½œåˆ†å‰²æˆå°å—
- **ä¼˜å…ˆçº§è°ƒåº¦**ï¼šé«˜ä¼˜å…ˆçº§ä»»åŠ¡å¯ä»¥ä¸­æ–­ä½ä¼˜å…ˆçº§ä»»åŠ¡
- **å¹¶å‘æ¸²æŸ“**ï¼šæ”¯æŒå¼‚æ­¥æ¸²æŸ“å’Œç”¨æˆ·äº¤äº’

### ç®—æ³•æ‰©å±•

- **å¹¿åº¦ä¼˜å…ˆéå†**ï¼šæŒ‰å±‚çº§éå† Fiber æ ‘
- **æ¡ä»¶éå†**ï¼šåªéå†æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„èŠ‚ç‚¹
- **åŒå‘éå†**ï¼šæ”¯æŒå‘å‰å’Œå‘åéå†

## ğŸ“ å¤ä¹ è¦ç‚¹

- [ ] ç†è§£ Fiber æ ‘çš„ä¸‰æŒ‡é’ˆç»“æ„
- [ ] æŒæ¡æ·±åº¦ä¼˜å…ˆéå†çš„å¾ªç¯å®ç°
- [ ] ç†Ÿæ‚‰å›æº¯æœºåˆ¶å’Œè¾¹ç•Œå¤„ç†
- [ ] ç†è§£å¾ªç¯éå†ç›¸æ¯”é€’å½’çš„ä¼˜åŠ¿
- [ ] èƒ½å¤Ÿæ„å»ºå’Œéå†å¤æ‚çš„ Fiber æ ‘
- [ ] ç†è§£ Fiber æ¶æ„åœ¨ React ä¸­çš„åº”ç”¨
