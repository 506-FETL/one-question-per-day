# Day 10 å¤ä¹ æ–‡æ¡£

## é¢˜ç›®æè¿°

æ‰‹å†™å®ç° JavaScript çš„**æ ¸å¿ƒæ–¹æ³•**ï¼ŒåŒ…æ‹¬ï¼š

- Function.prototype.call - æ”¹å˜å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡
- Function.prototype.apply - ç±»ä¼¼ callï¼Œä½†å‚æ•°ä¸ºæ•°ç»„
- Function.prototype.bind - è¿”å›ç»‘å®šä¸Šä¸‹æ–‡çš„æ–°å‡½æ•°
- instanceof æ“ä½œç¬¦ - æ£€æŸ¥åŸå‹é“¾å…³ç³»
- new æ“ä½œç¬¦ - åˆ›å»ºå®ä¾‹å¯¹è±¡

æœ¬é¢˜è€ƒæŸ¥ **this ç»‘å®šæœºåˆ¶**ã€**åŸå‹é“¾åŸç†** å’Œ **JavaScript åº•å±‚å®ç°** çš„æ·±åº¦ç†è§£ã€‚

## æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. this ç»‘å®šæœºåˆ¶çš„å››ç§è§„åˆ™

```javascript
// 1. é»˜è®¤ç»‘å®š - ç‹¬ç«‹å‡½æ•°è°ƒç”¨
function foo() {
  console.log(this);
}
foo(); // ä¸¥æ ¼æ¨¡å¼: undefined, éä¸¥æ ¼æ¨¡å¼: window

// 2. éšå¼ç»‘å®š - å¯¹è±¡æ–¹æ³•è°ƒç”¨
const obj = {
  foo() {
    console.log(this);
  },
};
obj.foo(); // this æŒ‡å‘ obj

// 3. æ˜¾å¼ç»‘å®š - call/apply/bind
foo.call(obj); // å¼ºåˆ¶ this æŒ‡å‘ obj

// 4. new ç»‘å®š - æ„é€ å‡½æ•°è°ƒç”¨
function Constructor() {
  this.name = "test";
}
new Constructor(); // this æŒ‡å‘æ–°åˆ›å»ºçš„å®ä¾‹
```

### 2. åŸå‹é“¾å…³ç³»å›¾

```javascript
function Person(name) {
  this.name = name;
}
Person.prototype.sayHello = function () {
  return `Hello, ${this.name}`;
};

const alice = new Person("Alice");

// åŸå‹é“¾å…³ç³»ï¼š
// alice.__proto__ === Person.prototype
// Person.prototype.__proto__ === Object.prototype
// Object.prototype.__proto__ === null
```

### 3. æ„é€ å‡½æ•°è°ƒç”¨çš„å››ä¸ªæ­¥éª¤

1. åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡
2. å°†ç©ºå¯¹è±¡çš„ **proto** æŒ‡å‘æ„é€ å‡½æ•°çš„ prototype
3. å°†æ„é€ å‡½æ•°çš„ this ç»‘å®šåˆ°æ–°å¯¹è±¡
4. å¦‚æœæ„é€ å‡½æ•°è¿”å›å¯¹è±¡ï¼Œåˆ™è¿”å›è¯¥å¯¹è±¡ï¼›å¦åˆ™è¿”å›æ–°å¯¹è±¡

### 4. Symbol çš„å¦™ç”¨

```javascript
// ä½¿ç”¨ Symbol é¿å…å±æ€§åå†²çª
const uniqueKey = Symbol("temp");
obj[uniqueKey] = func;
// æ‰§è¡Œååˆ é™¤ï¼Œä¸ä¼šæ±¡æŸ“åŸå¯¹è±¡
delete obj[uniqueKey];
```

## ä»£ç å®ç°

```javascript
/**
 * 1. æ‰‹å†™ Function.prototype.call
 * æ”¹å˜å‡½æ•°çš„ this æŒ‡å‘ï¼Œå¹¶ç«‹å³æ‰§è¡Œå‡½æ•°
 */
Function.prototype.myCall = function (context, ...args) {
  // å¤„ç†è¾¹ç•Œæƒ…å†µï¼šcontext ä¸º null æˆ– undefined
  if (context === null || context === undefined) {
    context = globalThis; // å…¼å®¹ Node.js å’Œæµè§ˆå™¨
  }

  // ç¡®ä¿ context æ˜¯å¯¹è±¡ç±»å‹
  context = new Object(context);

  // ä½¿ç”¨ Symbol åˆ›å»ºå”¯ä¸€å±æ€§åï¼Œé¿å…å†²çª
  const fnSymbol = Symbol("fn");

  // å°†å½“å‰å‡½æ•°èµ‹å€¼ç»™ context çš„å±æ€§
  context[fnSymbol] = this;

  try {
    // é€šè¿‡å¯¹è±¡æ–¹æ³•è°ƒç”¨çš„æ–¹å¼æ‰§è¡Œå‡½æ•°ï¼ˆéšå¼ç»‘å®šï¼‰
    const result = context[fnSymbol](...args);
    return result;
  } finally {
    // æ¸…ç†ä¸´æ—¶å±æ€§ï¼Œé¿å…æ±¡æŸ“åŸå¯¹è±¡
    delete context[fnSymbol];
  }
};

/**
 * 2. æ‰‹å†™ Function.prototype.apply
 * ä¸ call ç±»ä¼¼ï¼Œä½†å‚æ•°ä»¥æ•°ç»„å½¢å¼ä¼ é€’
 */
Function.prototype.myApply = function (context, argsArray) {
  // å¤„ç†è¾¹ç•Œæƒ…å†µ
  if (context === null || context === undefined) {
    context = globalThis;
  }

  context = new Object(context);

  // å‚æ•°æ•°ç»„é»˜è®¤ä¸ºç©ºæ•°ç»„
  const args = Array.isArray(argsArray) ? argsArray : [];

  const fnSymbol = Symbol("fn");
  context[fnSymbol] = this;

  try {
    const result = context[fnSymbol](...args);
    return result;
  } finally {
    delete context[fnSymbol];
  }
};

/**
 * 3. æ‰‹å†™ Function.prototype.bind
 * è¿”å›ä¸€ä¸ªæ–°å‡½æ•°ï¼Œé¢„è®¾ this å’Œéƒ¨åˆ†å‚æ•°ï¼ˆæŸ¯é‡ŒåŒ–ï¼‰
 */
Function.prototype.myBind = function (context, ...outerArgs) {
  // ä¿å­˜åŸå‡½æ•°
  const originalFunc = this;

  // æ£€æŸ¥è°ƒç”¨è€…æ˜¯å¦ä¸ºå‡½æ•°
  if (typeof originalFunc !== "function") {
    throw new TypeError("Function.prototype.bind called on non-function");
  }

  // è¿”å›ç»‘å®šåçš„æ–°å‡½æ•°
  const boundFunction = function (...innerArgs) {
    // åˆ¤æ–­æ˜¯å¦é€šè¿‡ new è°ƒç”¨
    if (new.target) {
      // new è°ƒç”¨ï¼šå¿½ç•¥ç»‘å®šçš„ thisï¼Œä½¿ç”¨æ–°åˆ›å»ºçš„å¯¹è±¡
      return new originalFunc(...outerArgs, ...innerArgs);
    } else {
      // æ™®é€šè°ƒç”¨ï¼šä½¿ç”¨ç»‘å®šçš„ this
      return originalFunc.myCall(context, ...outerArgs, ...innerArgs);
    }
  };

  // å¤„ç†åŸå‹é“¾ç»§æ‰¿
  if (originalFunc.prototype) {
    // åˆ›å»ºä¸€ä¸ªç©ºå‡½æ•°ä½œä¸ºä¸­ä»‹ï¼Œé¿å…ç›´æ¥å¼•ç”¨
    function Empty() {}
    Empty.prototype = originalFunc.prototype;
    boundFunction.prototype = new Empty();
  }

  return boundFunction;
};

/**
 * 4. æ‰‹å†™ instanceof æ“ä½œç¬¦
 * æ£€æŸ¥å¯¹è±¡çš„åŸå‹é“¾ä¸­æ˜¯å¦å­˜åœ¨æ„é€ å‡½æ•°çš„ prototype
 */
function myInstanceof(left, right) {
  // å¤„ç†åŸºæœ¬ç±»å‹
  if (typeof left !== "object" || left === null) {
    return false;
  }

  // æ£€æŸ¥å³ä¾§æ˜¯å¦ä¸ºå‡½æ•°
  if (typeof right !== "function") {
    throw new TypeError("Right-hand side of instanceof is not a function");
  }

  // è·å–æ„é€ å‡½æ•°çš„ prototype
  const prototype = right.prototype;

  // ä»å¯¹è±¡çš„åŸå‹é“¾å¼€å§‹æŸ¥æ‰¾
  let current = Object.getPrototypeOf(left);

  while (current !== null) {
    if (current === prototype) {
      return true;
    }
    current = Object.getPrototypeOf(current);
  }

  return false;
}

/**
 * 5. æ‰‹å†™ new æ“ä½œç¬¦
 * æ¨¡æ‹Ÿ new çš„å®Œæ•´è¿‡ç¨‹
 */
function myNew(constructor, ...args) {
  // æ£€æŸ¥æ„é€ å‡½æ•°
  if (typeof constructor !== "function") {
    throw new TypeError("Constructor must be a function");
  }

  // 1. åˆ›å»ºæ–°å¯¹è±¡ï¼Œå¹¶è®¾ç½®åŸå‹é“¾
  const newObj = Object.create(constructor.prototype);

  // 2. æ‰§è¡Œæ„é€ å‡½æ•°ï¼Œç»‘å®š this åˆ°æ–°å¯¹è±¡
  const result = constructor.apply(newObj, args);

  // 3. åˆ¤æ–­æ„é€ å‡½æ•°çš„è¿”å›å€¼
  // å¦‚æœè¿”å›å¯¹è±¡ç±»å‹ï¼Œåˆ™è¿”å›è¯¥å¯¹è±¡ï¼›å¦åˆ™è¿”å›æ–°åˆ›å»ºçš„å¯¹è±¡
  if (
    result !== null &&
    (typeof result === "object" || typeof result === "function")
  ) {
    return result;
  }

  return newObj;
}

/**
 * å¢å¼ºç‰ˆ bindï¼šæ”¯æŒæ›´å¤šç‰¹æ€§
 */
Function.prototype.myBindAdvanced = function (context, ...outerArgs) {
  const originalFunc = this;

  if (typeof originalFunc !== "function") {
    throw new TypeError("Function.prototype.bind called on non-function");
  }

  const boundFunction = function (...innerArgs) {
    const isNewCall = new.target === boundFunction;

    if (isNewCall) {
      // new è°ƒç”¨æ—¶çš„ç‰¹æ®Šå¤„ç†
      const instance = Object.create(originalFunc.prototype);
      const result = originalFunc.apply(instance, [...outerArgs, ...innerArgs]);

      // å¦‚æœæ„é€ å‡½æ•°è¿”å›å¯¹è±¡ï¼Œä½¿ç”¨è¯¥å¯¹è±¡ï¼›å¦åˆ™ä½¿ç”¨åˆ›å»ºçš„å®ä¾‹
      return result && typeof result === "object" ? result : instance;
    } else {
      // æ™®é€šè°ƒç”¨
      return originalFunc.apply(context, [...outerArgs, ...innerArgs]);
    }
  };

  // ç»´æŠ¤åŸå‹é“¾
  if (originalFunc.prototype) {
    boundFunction.prototype = Object.create(originalFunc.prototype);
  }

  // å¤åˆ¶å‡½æ•°å±æ€§
  Object.defineProperty(boundFunction, "length", {
    value: Math.max(0, originalFunc.length - outerArgs.length),
    configurable: true,
  });

  Object.defineProperty(boundFunction, "name", {
    value: `bound ${originalFunc.name}`,
    configurable: true,
  });

  return boundFunction;
};

/**
 * æ›´ç²¾ç¡®çš„ instanceof å®ç°
 */
function myInstanceofAdvanced(left, right) {
  // å¤„ç† null å’Œ undefined
  if (left == null) return false;

  // å¤„ç†åŸºæœ¬ç±»å‹çš„åŒ…è£…
  if (typeof left !== "object" && typeof left !== "function") {
    // æ£€æŸ¥åŸºæœ¬ç±»å‹çš„åŒ…è£…å¯¹è±¡
    if (right === String && typeof left === "string") return false;
    if (right === Number && typeof left === "number") return false;
    if (right === Boolean && typeof left === "boolean") return false;
    return false;
  }

  // æ£€æŸ¥å³ä¾§
  if (typeof right !== "function") {
    throw new TypeError("Right-hand side of instanceof is not callable");
  }

  // ç‰¹æ®Šå¤„ç†ï¼šFunction çš„ instanceof
  if (right === Function) {
    return typeof left === "function";
  }

  // ç‰¹æ®Šå¤„ç†ï¼šObject çš„ instanceof
  if (right === Object) {
    return typeof left === "object" || typeof left === "function";
  }

  const prototype = right.prototype;
  if (prototype == null) {
    throw new TypeError(
      "Function has non-object prototype in instanceof check",
    );
  }

  let current = Object.getPrototypeOf(left);

  while (current != null) {
    if (current === prototype) {
      return true;
    }
    current = Object.getPrototypeOf(current);
  }

  return false;
}

/**
 * æ”¯æŒç±»è¯­æ³•çš„ new å®ç°
 */
function myNewAdvanced(constructor, ...args) {
  if (typeof constructor !== "function") {
    throw new TypeError("Constructor must be a function");
  }

  // æ£€æŸ¥æ˜¯å¦ä¸ºç®­å¤´å‡½æ•°ï¼ˆä¸èƒ½ä½œä¸ºæ„é€ å‡½æ•°ï¼‰
  if (!constructor.prototype) {
    throw new TypeError("Constructor is not constructable");
  }

  // åˆ›å»ºæ–°å¯¹è±¡
  const newObj = Object.create(constructor.prototype);

  // è®¾ç½®æ­£ç¡®çš„ new.target
  const boundConstructor = constructor.bind(newObj);
  Object.defineProperty(boundConstructor, "prototype", {
    value: constructor.prototype,
  });

  try {
    const result = Reflect.construct(constructor, args, constructor);

    // æ£€æŸ¥è¿”å›å€¼
    if (
      result != null &&
      (typeof result === "object" || typeof result === "function")
    ) {
      return result;
    }
  } catch (error) {
    // å¦‚æœæ„é€ å‡½æ•°æ‰§è¡Œå‡ºé”™ï¼Œç¡®ä¿æ¸…ç†å·¥ä½œ
    throw error;
  }

  return newObj;
}
```

## ç®—æ³•åˆ†æ

- **æ—¶é—´å¤æ‚åº¦**: O(1) - call/apply/bind, O(n) - instanceof(nä¸ºåŸå‹é“¾é•¿åº¦)
- **ç©ºé—´å¤æ‚åº¦**: O(1) - åŸºæœ¬å®ç°ï¼ŒO(1) - ä¸´æ—¶Symbolå±æ€§
- **ç‰¹ç‚¹**: åŸç”ŸJSè¡Œä¸ºæ¨¡æ‹Ÿã€åŸå‹é“¾æ“ä½œã€thisç»‘å®š

## å…³é”®æŠ€æœ¯ç‚¹

### 1. Symbol é¿å…å±æ€§å†²çª

```javascript
// é”™è¯¯æ–¹å¼ï¼šå¯èƒ½è¦†ç›–å·²æœ‰å±æ€§
context.fn = this;

// æ­£ç¡®æ–¹å¼ï¼šä½¿ç”¨ Symbol ç¡®ä¿å”¯ä¸€æ€§
const fnSymbol = Symbol("temp");
context[fnSymbol] = this;
```

### 2. call/apply çš„æ ¸å¿ƒåŸç†

```javascript
// æ ¸å¿ƒæ€æƒ³ï¼šåˆ©ç”¨éšå¼ç»‘å®šæ”¹å˜ this
// obj.method() -> method å†…çš„ this æŒ‡å‘ obj

function myCall(context, ...args) {
  context[fn] = this; // å°†å‡½æ•°ä½œä¸º context çš„æ–¹æ³•
  context[fn](...args); // è°ƒç”¨æ–¹æ³•ï¼Œthis è‡ªåŠ¨ç»‘å®šåˆ° context
  delete context[fn]; // æ¸…ç†ä¸´æ—¶å±æ€§
}
```

### 3. bind çš„ new è°ƒç”¨æ£€æµ‹

```javascript
function boundFunction(...args) {
  // æ£€æµ‹æ˜¯å¦é€šè¿‡ new è°ƒç”¨
  if (new.target) {
    // new è°ƒç”¨ï¼šå¿½ç•¥ç»‘å®šçš„ this
    return new originalFunc(...outerArgs, ...args);
  } else {
    // æ™®é€šè°ƒç”¨ï¼šä½¿ç”¨ç»‘å®šçš„ this
    return originalFunc.call(context, ...outerArgs, ...args);
  }
}
```

### 4. instanceof çš„åŸå‹é“¾éå†

```javascript
function myInstanceof(obj, constructor) {
  let current = Object.getPrototypeOf(obj);
  const target = constructor.prototype;

  // æ²¿ç€åŸå‹é“¾å‘ä¸ŠæŸ¥æ‰¾
  while (current !== null) {
    if (current === target) return true;
    current = Object.getPrototypeOf(current);
  }

  return false;
}
```

### 5. å¸¸è§é™·é˜±å’Œå‘ç‚¹

- **thisä¸¢å¤±**: ä¸ä½¿ç”¨éšå¼ç»‘å®šæ”¹å˜thisæŒ‡å‘
- **å±æ€§æ±¡æŸ“**: ç›´æ¥åœ¨å¯¹è±¡ä¸Šæ·»åŠ å±æ€§è€Œä¸æ¸…ç†
- **å‚æ•°å¤„ç†**: applyçš„å‚æ•°ä¸æ˜¯æ•°ç»„æ—¶çš„å¤„ç†
- **newæ£€æµ‹**: bindå‡½æ•°è¢«newè°ƒç”¨æ—¶çš„ç‰¹æ®Šå¤„ç†
- **åŸå‹é“¾**: instanceofçš„åŸå‹é“¾éå†ç»ˆæ­¢æ¡ä»¶

## ä½¿ç”¨ç¤ºä¾‹

```javascript
// call ä½¿ç”¨ç¤ºä¾‹
function greet(greeting, punctuation) {
  return `${greeting}, ${this.name}${punctuation}`;
}

const person = { name: "Alice" };
console.log(greet.myCall(person, "Hello", "!")); // "Hello, Alice!"

// apply ä½¿ç”¨ç¤ºä¾‹
const numbers = [1, 5, 3, 9, 2];
console.log(Math.max.myApply(null, numbers)); // 9

// bind ä½¿ç”¨ç¤ºä¾‹
const boundGreet = greet.myBind(person, "Hi");
console.log(boundGreet("?")); // "Hi, Alice?"

// bind çš„ new è°ƒç”¨
function Person(name, age) {
  this.name = name;
  this.age = age;
}

const BoundPerson = Person.myBind(null, "John");
const john = new BoundPerson(25);
console.log(john.name); // "John"
console.log(john.age); // 25

// instanceof ä½¿ç”¨ç¤ºä¾‹
console.log(myInstanceof(john, Person)); // true
console.log(myInstanceof(john, Object)); // true
console.log(myInstanceof(john, Array)); // false

// new ä½¿ç”¨ç¤ºä¾‹
function Car(brand, model) {
  this.brand = brand;
  this.model = model;
  this.start = function () {
    return `${this.brand} ${this.model} is starting`;
  };
}

const myCar = myNew(Car, "Toyota", "Camry");
console.log(myCar.brand); // "Toyota"
console.log(myCar.start()); // "Toyota Camry is starting"

// æ„é€ å‡½æ•°è¿”å›å¯¹è±¡çš„æƒ…å†µ
function SpecialConstructor() {
  this.name = "instance";
  return { custom: "object" }; // è¿”å›è‡ªå®šä¹‰å¯¹è±¡
}

const special = myNew(SpecialConstructor);
console.log(special.custom); // "object"
console.log(special.name); // undefined

// å¤æ‚ç»§æ‰¿ç¤ºä¾‹
function Animal(name) {
  this.name = name;
}

Animal.prototype.speak = function () {
  return `${this.name} makes a sound`;
};

function Dog(name, breed) {
  Animal.myCall(this, name);
  this.breed = breed;
}

// è®¾ç½®åŸå‹é“¾
Dog.prototype = Object.create(Animal.prototype);
Dog.prototype.constructor = Dog;

Dog.prototype.bark = function () {
  return `${this.name} barks!`;
};

const dog = myNew(Dog, "Buddy", "Golden Retriever");
console.log(dog.speak()); // "Buddy makes a sound"
console.log(dog.bark()); // "Buddy barks!"
console.log(myInstanceof(dog, Dog)); // true
console.log(myInstanceof(dog, Animal)); // true

// è¾¹ç•Œæƒ…å†µæµ‹è¯•
console.log(greet.myCall(null, "Hello", "!")); // thisæŒ‡å‘global
console.log(greet.myCall(undefined, "Hi", "?")); // thisæŒ‡å‘global
console.log(greet.myCall(42, "Hey", ".")); // thisæŒ‡å‘NumberåŒ…è£…å¯¹è±¡

// ç®­å¤´å‡½æ•°ä¸ bindï¼ˆç®­å¤´å‡½æ•°æ— æ³•ç»‘å®š thisï¼‰
const arrowFunc = (x) => x * 2;
const boundArrow = arrowFunc.myBind({ value: 10 });
console.log(boundArrow(5)); // 10ï¼ˆthisç»‘å®šæ— æ•ˆï¼‰

// å¼‚å¸¸å¤„ç†æµ‹è¯•
try {
  myInstanceof(123, "not a function");
} catch (e) {
  console.log(e.message); // "Right-hand side of instanceof is not a function"
}

try {
  myNew("not a function");
} catch (e) {
  console.log(e.message); // "Constructor must be a function"
}

// æ€§èƒ½å¯¹æ¯”æµ‹è¯•
function performanceTest() {
  const iterations = 1000000;
  const obj = { name: "Test" };

  function testFunc() {
    return this.name;
  }

  // åŸç”Ÿ call
  console.time("Native call");
  for (let i = 0; i < iterations; i++) {
    testFunc.call(obj);
  }
  console.timeEnd("Native call");

  // è‡ªå®ç° call
  console.time("Custom call");
  for (let i = 0; i < iterations; i++) {
    testFunc.myCall(obj);
  }
  console.timeEnd("Custom call");
}

// performanceTest()
```

## è®°å¿†è¦ç‚¹

### æ ¸å¿ƒè®°å¿†ç‚¹

1. **SymbolæŠ€å·§** - ä½¿ç”¨Symbolé¿å…å±æ€§åå†²çª
2. **éšå¼ç»‘å®š** - é€šè¿‡å¯¹è±¡æ–¹æ³•è°ƒç”¨æ”¹å˜thisæŒ‡å‘
3. **newæ£€æµ‹** - bindå‡½æ•°ä¸­åˆ¤æ–­æ˜¯å¦é€šè¿‡newè°ƒç”¨
4. **åŸå‹é“¾éå†** - instanceofçš„æŸ¥æ‰¾è¿‡ç¨‹
5. **è¿”å›å€¼å¤„ç†** - æ„é€ å‡½æ•°è¿”å›å¯¹è±¡æ—¶çš„ç‰¹æ®Šæƒ…å†µ

### å®ç°æ¨¡å¼è®°å¿†

```javascript
// call/apply æ¨¡å¼
// 1. å¤„ç†contextï¼ˆnull/undefinedï¼‰
// 2. åˆ›å»ºSymbolå±æ€§
// 3. èµ‹å€¼å‡½æ•°å¹¶è°ƒç”¨
// 4. æ¸…ç†ä¸´æ—¶å±æ€§

// bind æ¨¡å¼
// 1. ä¿å­˜åŸå‡½æ•°
// 2. è¿”å›æ–°å‡½æ•°
// 3. æ£€æµ‹newè°ƒç”¨
// 4. é€‰æ‹©åˆé€‚çš„this
```

## æ‰©å±•æ€è€ƒ

### 1. æ”¯æŒå¼‚æ­¥å‡½æ•°çš„bind

```javascript
Function.prototype.asyncBind = function (context, ...outerArgs) {
  const originalFunc = this;

  return async function (...innerArgs) {
    if (new.target) {
      throw new TypeError("Async function cannot be called with new");
    }

    try {
      const result = await originalFunc.myCall(
        context,
        ...outerArgs,
        ...innerArgs,
      );
      return result;
    } catch (error) {
      throw error;
    }
  };
};

// ä½¿ç”¨ç¤ºä¾‹
async function fetchData(url) {
  const response = await fetch(url);
  return `Data from ${this.name}: ${response.status}`;
}

const api = { name: "UserAPI" };
const boundFetch = fetchData.asyncBind(api);
boundFetch("/users").then(console.log);
```

### 2. æ”¯æŒè£…é¥°å™¨çš„call

```javascript
Function.prototype.decoratedCall = function (
  context,
  decorators = [],
  ...args
) {
  let func = this;

  // åº”ç”¨è£…é¥°å™¨
  for (const decorator of decorators.reverse()) {
    func = decorator(func);
  }

  return func.myCall(context, ...args);
};

// è£…é¥°å™¨ç¤ºä¾‹
function logDecorator(func) {
  return function (...args) {
    console.log(`Calling ${func.name} with args:`, args);
    const result = func.apply(this, args);
    console.log(`Result:`, result);
    return result;
  };
}

function timingDecorator(func) {
  return function (...args) {
    const start = performance.now();
    const result = func.apply(this, args);
    const end = performance.now();
    console.log(`Execution time: ${end - start}ms`);
    return result;
  };
}

// ä½¿ç”¨ç¤ºä¾‹
function calculate(a, b) {
  return a + b;
}

calculate.decoratedCall({}, [logDecorator, timingDecorator], 5, 3);
```

### 3. æ”¯æŒæŸ¯é‡ŒåŒ–çš„bind

```javascript
Function.prototype.curry = function (...outerArgs) {
  const originalFunc = this;
  const totalArgs = originalFunc.length;

  function curried(...currentArgs) {
    const allArgs = [...outerArgs, ...currentArgs];

    if (allArgs.length >= totalArgs) {
      return originalFunc.apply(this, allArgs);
    } else {
      return curried.bind(this, ...currentArgs);
    }
  }

  return curried;
};

// ä½¿ç”¨ç¤ºä¾‹
function multiply(a, b, c) {
  return a * b * c;
}

const curriedMultiply = multiply.curry();
const step1 = curriedMultiply(2);
const step2 = step1(3);
const result = step2(4); // 24
```

### 4. æ”¯æŒç®¡é“çš„apply

```javascript
Function.prototype.pipeline = function (context, ...funcs) {
  return (...args) => {
    let result = this.myApply(context, args);

    for (const func of funcs) {
      result = func.call(context, result);
    }

    return result;
  };
};

// ä½¿ç”¨ç¤ºä¾‹
function add(a, b) {
  return a + b;
}

function double(x) {
  return x * 2;
}

function square(x) {
  return x * x;
}

const pipeline = add.pipeline(null, double, square);
console.log(pipeline(3, 4)); // ((3+4)*2)^2 = 196
```

### 5. æ”¯æŒç¼“å­˜çš„new

```javascript
function memoizedNew(constructor, cacheKey) {
  const cache = new Map();

  return function (...args) {
    const key = cacheKey ? cacheKey(...args) : JSON.stringify(args);

    if (cache.has(key)) {
      return cache.get(key);
    }

    const instance = myNew(constructor, ...args);
    cache.set(key, instance);

    return instance;
  };
}

// ä½¿ç”¨ç¤ºä¾‹
function ExpensiveObject(id, data) {
  this.id = id;
  this.data = data;
  this.processed = this.heavyProcessing(data);
}

ExpensiveObject.prototype.heavyProcessing = function (data) {
  // æ¨¡æ‹Ÿæ˜‚è´µæ“ä½œ
  return data.toUpperCase();
};

const createCachedObject = memoizedNew(
  ExpensiveObject,
  (id) => id, // ç¼“å­˜é”®ä¸º id
);

const obj1 = createCachedObject(1, "test");
const obj2 = createCachedObject(1, "different"); // è¿”å›ç¼“å­˜çš„ obj1
console.log(obj1 === obj2); // true
```

## å¤ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£thisç»‘å®šçš„å››ç§è§„åˆ™å’Œä¼˜å…ˆçº§
- [ ] æŒæ¡call/apply/bindçš„å®ç°åŸç†
- [ ] ç†Ÿç»ƒä½¿ç”¨Symbolé¿å…å±æ€§åå†²çª
- [ ] ç†è§£newæ“ä½œç¬¦çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹
- [ ] æŒæ¡instanceofçš„åŸå‹é“¾æŸ¥æ‰¾æœºåˆ¶
- [ ] èƒ½å¤Ÿå¤„ç†å„ç§è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸
- [ ] äº†è§£åŸç”Ÿå®ç°ä¸è‡ªå®šä¹‰å®ç°çš„æ€§èƒ½å·®å¼‚
- [ ] ç†Ÿæ‚‰åŸå‹é“¾å’Œæ„é€ å‡½æ•°çš„å…³ç³»
- [ ] èƒ½å¤Ÿæ‰©å±•å’Œä¼˜åŒ–åŸºç¡€å®ç°
- [ ] ç†è§£åœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨åœºæ™¯
      delete context[fn]
      return res
      }

// 2. æ‰‹å†™ apply
Function.prototype.Apply = function (context, args = []) {
if (context === undefined || context === null) {
context = window
}
let fn = Symbol()
context[fn] = this
let res = context[fn](...args)
delete context[fn]
return res
}

// 3. æ‰‹å†™ bind
Function.prototype.Bind = function (context, ...args) {
if (context === undefined || context === null) {
context = window
}
let fn = this
let f = Symbol()
const result = function (...args1) {
if (this instanceof fn) {
// resultå¦‚æœä½œä¸ºæ„é€ å‡½æ•°è¢«è°ƒç”¨ï¼ŒthisæŒ‡å‘çš„æ˜¯newå‡ºæ¥çš„å¯¹è±¡
// this instanceof fnï¼Œåˆ¤æ–­newå‡ºæ¥çš„å¯¹è±¡æ˜¯å¦ä¸ºfnçš„å®ä¾‹
this[f] = fn
let res = this[f](...args, ...args1)
delete this[f]
return res
} else {
// bindè¿”å›çš„å‡½æ•°ä½œä¸ºæ™®é€šå‡½æ•°è¢«è°ƒç”¨æ—¶
context[f] = fn
let res = context[f](...args, ...args1)
delete context[f]
return res
}
}
// å¦‚æœç»‘å®šçš„æ˜¯æ„é€ å‡½æ•° é‚£ä¹ˆéœ€è¦ç»§æ‰¿æ„é€ å‡½æ•°åŸå‹å±æ€§å’Œæ–¹æ³•
result.prototype = Object.create(fn.prototype)
result.prototype.constructor = result
return result
}

// 4. æ‰‹å†™ instanceof
export function instanceOf(obj, fn) {
let proto = obj.**proto**
if (proto) {
if (proto === fn.prototype) {
return true
} else {
return instanceOf(proto, fn)
}
} else {
return false
}
}

// 5. æ‰‹å†™ new
export function selfNew(fn, ...args) {
// åˆ›å»ºä¸€ä¸ªinstanceå¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„åŸå‹æ˜¯fn.prototype
let instance = Object.create(fn.prototype)
// è°ƒç”¨æ„é€ å‡½æ•°ï¼Œä½¿ç”¨applyï¼Œå°†thisæŒ‡å‘æ–°ç”Ÿæˆçš„å¯¹è±¡
let res = fn.apply(instance, args)
// å¦‚æœfnå‡½æ•°æœ‰è¿”å›å€¼ï¼Œå¹¶ä¸”è¿”å›å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–æ–¹æ³•ï¼Œåˆ™è¿”å›è¯¥å¯¹è±¡ï¼Œå¦åˆ™è¿”å›æ–°ç”Ÿæˆçš„instanceå¯¹è±¡
return typeof res === 'object' || typeof res === 'function' ? res : instance
}

````

## ğŸ§  ç®—æ³•åˆ†æ

### æ ¸å¿ƒæ€è·¯

1. **call/apply**ï¼šé€šè¿‡å¯¹è±¡å±æ€§è°ƒç”¨å®ç° this ç»‘å®š
2. **bind**ï¼šè¿”å›æ–°å‡½æ•°ï¼Œæ”¯æŒé¢„è®¾å‚æ•°å’Œæ„é€ å‡½æ•°è°ƒç”¨
3. **instanceof**ï¼šé€’å½’æŸ¥æ‰¾åŸå‹é“¾ï¼Œæ¯”è¾ƒ prototype
4. **new**ï¼šåˆ›å»ºå¯¹è±¡ã€ç»‘å®šåŸå‹ã€æ‰§è¡Œæ„é€ å‡½æ•°ã€å¤„ç†è¿”å›å€¼

### æ—¶é—´å¤æ‚åº¦

- **call/apply**ï¼šO(1) - ç›´æ¥å±æ€§è®¿é—®å’Œè°ƒç”¨
- **bind**ï¼šO(1) - è¿”å›å‡½æ•°åˆ›å»º
- **instanceof**ï¼šO(n) - n ä¸ºåŸå‹é“¾æ·±åº¦
- **new**ï¼šO(1) - å¯¹è±¡åˆ›å»ºå’Œå‡½æ•°è°ƒç”¨

### ç©ºé—´å¤æ‚åº¦

- **call/apply**ï¼šO(1) - ä¸´æ—¶å±æ€§å­˜å‚¨
- **bind**ï¼šO(1) - é—­åŒ…å˜é‡å­˜å‚¨
- **instanceof**ï¼šO(n) - é€’å½’è°ƒç”¨æ ˆ
- **new**ï¼šO(1) - æ–°å¯¹è±¡åˆ›å»º

## ğŸ” å…³é”®æŠ€æœ¯ç‚¹

### 1. Symbol é¿å…å±æ€§å†²çª

```javascript
let fn = Symbol() // åˆ›å»ºå”¯ä¸€æ ‡è¯†ç¬¦
context[fn] = this // é¿å…è¦†ç›–åŸæœ‰å±æ€§
````

### 2. åŸå‹é“¾é€’å½’æŸ¥æ‰¾

```javascript
function instanceOf(obj, fn) {
  const proto = obj.__proto__;
  if (proto === fn.prototype) return true;
  return proto ? instanceOf(proto, fn) : false;
}
```

### 3. æ„é€ å‡½æ•°è¿”å›å€¼å¤„ç†

```javascript
// new æ“ä½œéœ€è¦åˆ¤æ–­æ„é€ å‡½æ•°çš„è¿”å›å€¼ç±»å‹
return typeof res === "object" || typeof res === "function" ? res : instance;
```

### 4. bind çš„æ„é€ å‡½æ•°æ£€æµ‹

```javascript
if (this instanceof fn) {
  // ä½œä¸ºæ„é€ å‡½æ•°è°ƒç”¨æ—¶çš„ç‰¹æ®Šå¤„ç†
} else {
  // æ™®é€šå‡½æ•°è°ƒç”¨
}
```

### 5. åŸå‹ç»§æ‰¿çš„æ­£ç¡®å»ºç«‹

```javascript
result.prototype = Object.create(fn.prototype);
result.prototype.constructor = result;
```

## ğŸ§ª ä½¿ç”¨ç¤ºä¾‹

### call å’Œ apply ç¤ºä¾‹

```javascript
function greet(greeting, punctuation) {
  return `${greeting}, ${this.name}${punctuation}`;
}

const person = { name: "Alice" };

// call ç”¨æ³•
greet.Call(person, "Hello", "!"); // "Hello, Alice!"

// apply ç”¨æ³•
greet.Apply(person, ["Hi", "?"]); // "Hi, Alice?"
```

### bind ç¤ºä¾‹

```javascript
function multiply(a, b) {
  return a * b;
}

// æ™®é€šç»‘å®š
const double = multiply.Bind(null, 2);
double(5); // 10

// æ„é€ å‡½æ•°ç»‘å®š
function Person(name) {
  this.name = name;
}

const BoundPerson = Person.Bind(null, "John");
const john = new BoundPerson(); // {name: 'John'}
```

### instanceof ç¤ºä¾‹

```javascript
function Animal() {}
function Dog() {}
Dog.prototype = Object.create(Animal.prototype);

const dog = new Dog();
instanceOf(dog, Dog); // true
instanceOf(dog, Animal); // true
instanceOf(dog, Object); // true
```

### new ç¤ºä¾‹

```javascript
function Car(brand) {
  this.brand = brand;
  this.wheels = 4;
}

const car = selfNew(Car, "Toyota");
// car: {brand: 'Toyota', wheels: 4, __proto__: Car.prototype}

// æ„é€ å‡½æ•°è¿”å›å¯¹è±¡çš„æƒ…å†µ
function Factory() {
  return { type: "custom" };
}

const obj = selfNew(Factory); // {type: 'custom'}
```

## ğŸ’¡ å…³é”®è®°å¿†ç‚¹

1. **call/apply åŸç†**ï¼šé€šè¿‡å¯¹è±¡å±æ€§è°ƒç”¨å®ç° this ç»‘å®š
2. **bind åŒé‡åŠŸèƒ½**ï¼šæ™®é€šè°ƒç”¨ + æ„é€ å‡½æ•°è°ƒç”¨çš„ä¸åŒå¤„ç†
3. **instanceof æœ¬è´¨**ï¼šé€’å½’æŸ¥æ‰¾åŸå‹é“¾ä¸Šçš„ prototype
4. **new å››æ­¥éª¤**ï¼šåˆ›å»ºå¯¹è±¡ â†’ ç»‘å®šåŸå‹ â†’ æ‰§è¡Œå‡½æ•° â†’ è¿”å›ç»“æœ
5. **Symbol çš„ä½œç”¨**ï¼šé¿å…ä¸´æ—¶å±æ€§ä¸åŸæœ‰å±æ€§å†²çª
6. **åŸå‹ç»§æ‰¿**ï¼šbind è¿”å›çš„å‡½æ•°éœ€è¦æ­£ç¡®ç»§æ‰¿åŸå‹

## ğŸ¤” æ‰©å±•æ€è€ƒ

### this ç»‘å®šä¼˜å…ˆçº§

1. **new ç»‘å®š** > **æ˜¾å¼ç»‘å®š** > **éšå¼ç»‘å®š** > **é»˜è®¤ç»‘å®š**
2. bind åœ¨ new è°ƒç”¨æ—¶ä¼šè¢«å¿½ç•¥

### è¾¹ç•Œæƒ…å†µå¤„ç†

- **null/undefined context**ï¼šé»˜è®¤ç»‘å®šåˆ°å…¨å±€å¯¹è±¡
- **æ„é€ å‡½æ•°è¿”å›å¯¹è±¡**ï¼šè¿”å›è¯¥å¯¹è±¡è€Œéå®ä¾‹
- **åŸå‹é“¾æ–­è£‚**ï¼šinstanceof éœ€è¦å¤„ç† null åŸå‹

### æ€§èƒ½è€ƒè™‘

- **Symbol åˆ›å»ºæˆæœ¬**ï¼šæ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–°çš„ Symbol
- **é€’å½’æ·±åº¦é™åˆ¶**ï¼šåŸå‹é“¾è¿‡é•¿å¯èƒ½å¯¼è‡´æ ˆæº¢å‡º
- **å†…å­˜æ³„æ¼é£é™©**ï¼šä¸´æ—¶å±æ€§éœ€è¦åŠæ—¶æ¸…ç†

## ğŸ“ å¤ä¹ è¦ç‚¹

- [ ] ç†è§£ this ç»‘å®šçš„å››ç§æ–¹å¼å’Œä¼˜å…ˆçº§
- [ ] æŒæ¡åŸå‹é“¾çš„æŸ¥æ‰¾æœºåˆ¶å’Œæ–­ç‚¹å¤„ç†
- [ ] ç†Ÿæ‚‰æ„é€ å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹å’Œè¿”å›å€¼è§„åˆ™
- [ ] èƒ½å¤Ÿå®ç° callã€applyã€bind çš„æ ¸å¿ƒé€»è¾‘
- [ ] ç†è§£ instanceof å’Œ new çš„åº•å±‚åŸç†
- [ ] æŒæ¡ Symbol åœ¨é¿å…å±æ€§å†²çªä¸­çš„åº”ç”¨
