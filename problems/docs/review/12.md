# Day 12 å¤ä¹ æ–‡æ¡£

## é¢˜ç›®æè¿°

å®ç°ä¸€ä¸ª **compose å‡½æ•°**ï¼Œç”¨äºå‡½æ•°ç»„åˆï¼š

- å°†ä¸€ç³»åˆ—å‡½æ•°åƒç®¡é“ä¸€æ ·è¿æ¥èµ·æ¥
- æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å‡½æ•°çš„æ··åˆç»„åˆ
- æ•°æ®ä»ç¬¬ä¸€ä¸ªå‡½æ•°æµå‘æœ€åä¸€ä¸ªå‡½æ•°
- å®ç°å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„æ ¸å¿ƒæ¦‚å¿µ

æœ¬é¢˜è€ƒæŸ¥ **å‡½æ•°å¼ç¼–ç¨‹**ã€**å¼‚æ­¥ç¼–ç¨‹** å’Œ **é«˜é˜¶å‡½æ•°** çš„ç»¼åˆåº”ç”¨ã€‚

## æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. å‡½æ•°ç»„åˆçš„æ ¸å¿ƒæ¦‚å¿µ

```javascript
// å‡½æ•°ç»„åˆçš„åŸºæœ¬æ€æƒ³
const add = (x) => x + 1;
const multiply = (x) => x * 2;
const square = (x) => x * x;

// ä¼ ç»Ÿå†™æ³•
const result = square(multiply(add(5))); // ((5+1)*2)Â² = 144

// compose å†™æ³•
const composed = compose([add, multiply, square]);
const result = composed(5); // 144
```

### 2. æ‰§è¡Œé¡ºåºï¼ˆä»å·¦åˆ°å³ï¼‰

```javascript
// compose([f, g, h]) æ‰§è¡Œé¡ºåºï¼š
// input â†’ f(input) â†’ g(f(input)) â†’ h(g(f(input))) â†’ output

// è¿™ä¸æ•°å­¦ä¸­çš„å‡½æ•°ç»„åˆ hâˆ˜gâˆ˜f ç›¸å
// ä½†æ›´ç¬¦åˆç›´è§‰çš„æ•°æ®æµåŠ¨æ–¹å‘
```

### 3. åŒæ­¥ä¸å¼‚æ­¥å…¼å®¹

```javascript
// åŒæ­¥å‡½æ•°
const syncFn = (x) => x * 2;

// å¼‚æ­¥å‡½æ•°
const asyncFn = (x) => Promise.resolve(x + 1);

// æ··åˆä½¿ç”¨
const mixed = compose([syncFn, asyncFn, syncFn]);
// è‡ªåŠ¨å¤„ç†åŒæ­¥/å¼‚æ­¥çš„å·®å¼‚
```

### 4. Promise é“¾å¼å¤„ç†

```javascript
// æ ¸å¿ƒåŸç†ï¼šå°†æ‰€æœ‰å‡½æ•°è¿”å›å€¼ç”¨ Promise.resolve åŒ…è£…
// ç¡®ä¿ .then() æ–¹æ³•å§‹ç»ˆå¯ç”¨
return fns.reduce((promise, fn) => promise.then(fn), Promise.resolve(input));
```

## ä»£ç å®ç°

```javascript
/**
 * åŸºç¡€ç‰ˆæœ¬ï¼šæ”¯æŒåŒæ­¥å’Œå¼‚æ­¥å‡½æ•°ç»„åˆ
 * æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œç©ºé—´å¤æ‚åº¦ï¼šO(1)
 */
export default function compose(fns) {
  // è¾¹ç•Œæƒ…å†µï¼šç©ºæ•°ç»„
  if (fns.length === 0) {
    return (x) => x;
  }

  // è¾¹ç•Œæƒ…å†µï¼šå•ä¸ªå‡½æ•°
  if (fns.length === 1) {
    return fns[0];
  }

  return function (...args) {
    // ç¬¬ä¸€ä¸ªå‡½æ•°å¯ä»¥æ¥æ”¶å¤šä¸ªå‚æ•°
    const firstFn = fns[0];
    const restFns = fns.slice(1);

    // æ‰§è¡Œç¬¬ä¸€ä¸ªå‡½æ•°
    const initialResult = firstFn(...args);

    // ä½¿ç”¨ reduce ä¾æ¬¡æ‰§è¡Œå‰©ä½™å‡½æ•°
    return restFns.reduce((promise, currentFn) => {
      return promise.then((result) => {
        // ç¡®ä¿è¿”å›å€¼è¢« Promise åŒ…è£…
        const fnResult = currentFn(result);
        return Promise.resolve(fnResult);
      });
    }, Promise.resolve(initialResult));
  };
}

/**
 * å¢å¼ºç‰ˆæœ¬ï¼šæ”¯æŒé”™è¯¯å¤„ç†å’Œç±»å‹æ£€æŸ¥
 */
function composeAdvanced(fns) {
  // å‚æ•°éªŒè¯
  if (!Array.isArray(fns)) {
    throw new TypeError("compose expects an array of functions");
  }

  // æ£€æŸ¥æ‰€æœ‰å…ƒç´ éƒ½æ˜¯å‡½æ•°
  for (let i = 0; i < fns.length; i++) {
    if (typeof fns[i] !== "function") {
      throw new TypeError(`Element at index ${i} is not a function`);
    }
  }

  if (fns.length === 0) {
    return (x) => Promise.resolve(x);
  }

  if (fns.length === 1) {
    return (...args) => Promise.resolve(fns[0](...args));
  }

  return function (...args) {
    const [firstFn, ...restFns] = fns;

    try {
      const initialResult = firstFn(...args);

      return restFns.reduce((promise, currentFn) => {
        return promise.then((result) => {
          try {
            const fnResult = currentFn(result);
            return Promise.resolve(fnResult);
          } catch (error) {
            return Promise.reject(error);
          }
        });
      }, Promise.resolve(initialResult));
    } catch (error) {
      return Promise.reject(error);
    }
  };
}

/**
 * å³åˆ°å·¦ç»„åˆç‰ˆæœ¬ï¼ˆä¼ ç»Ÿæ•°å­¦å‡½æ•°ç»„åˆï¼‰
 */
function composeRight(fns) {
  if (fns.length === 0) return (x) => x;
  if (fns.length === 1) return fns[0];

  return function (...args) {
    // ä»å³åˆ°å·¦æ‰§è¡Œï¼šæœ€åä¸€ä¸ªå‡½æ•°å…ˆæ‰§è¡Œ
    const lastFn = fns[fns.length - 1];
    const restFns = fns.slice(0, -1).reverse();

    const initialResult = lastFn(...args);

    return restFns.reduce(
      (promise, currentFn) => promise.then(currentFn),
      Promise.resolve(initialResult),
    );
  };
}

/**
 * æ”¯æŒç®¡é“æ“ä½œç¬¦çš„ç‰ˆæœ¬
 */
function pipe(fns) {
  // pipe æ˜¯ compose çš„åˆ«åï¼Œä½†æ›´ç›´è§‚åœ°è¡¨ç¤ºä»å·¦åˆ°å³
  return compose(fns);
}

/**
 * æ”¯æŒä¸­é—´ä»¶æ¨¡å¼çš„ç»„åˆ
 */
function composeMiddleware(middlewares) {
  return function (context, next) {
    let index = -1;

    function dispatch(i) {
      if (i <= index) {
        return Promise.reject(new Error("next() called multiple times"));
      }

      index = i;
      let fn = middlewares[i];

      if (i === middlewares.length) {
        fn = next;
      }

      if (!fn) {
        return Promise.resolve();
      }

      try {
        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));
      } catch (err) {
        return Promise.reject(err);
      }
    }

    return dispatch(0);
  };
}

/**
 * æ”¯æŒå¹¶è¡Œæ‰§è¡Œçš„ç»„åˆ
 */
function composeParallel(fns) {
  return function (...args) {
    const results = fns.map((fn) => {
      try {
        return Promise.resolve(fn(...args));
      } catch (error) {
        return Promise.reject(error);
      }
    });

    return Promise.all(results);
  };
}

/**
 * æ”¯æŒæ¡ä»¶æ‰§è¡Œçš„ç»„åˆ
 */
function composeConditional(conditions, fns) {
  if (conditions.length !== fns.length) {
    throw new Error(
      "conditions and functions arrays must have the same length",
    );
  }

  return function (...args) {
    let result = Promise.resolve(args[0]);

    for (let i = 0; i < fns.length; i++) {
      result = result.then((value) => {
        const shouldExecute = conditions[i](value);
        return shouldExecute ? fns[i](value) : value;
      });
    }

    return result;
  };
}

/**
 * æ”¯æŒé‡è¯•æœºåˆ¶çš„ç»„åˆ
 */
function composeWithRetry(fns, maxRetries = 3) {
  return function (...args) {
    const executeWithRetry = (fn, value, retries = 0) => {
      return Promise.resolve(fn(value)).catch((error) => {
        if (retries < maxRetries) {
          console.log(
            `Retrying function (attempt ${retries + 1}/${maxRetries})`,
          );
          return executeWithRetry(fn, value, retries + 1);
        }
        throw error;
      });
    };

    const [firstFn, ...restFns] = fns;
    let result = Promise.resolve(firstFn(...args));

    for (const fn of restFns) {
      result = result.then((value) => executeWithRetry(fn, value));
    }

    return result;
  };
}

/**
 * æ”¯æŒæ€§èƒ½ç›‘æ§çš„ç»„åˆ
 */
function composeWithTiming(fns, onTiming) {
  return function (...args) {
    const timings = [];
    const [firstFn, ...restFns] = fns;

    const executeWithTiming = (fn, value, index) => {
      const start = performance.now();

      return Promise.resolve(fn(value)).then((result) => {
        const end = performance.now();
        const timing = {
          functionIndex: index,
          duration: end - start,
          functionName: fn.name || `anonymous_${index}`,
        };

        timings.push(timing);

        if (onTiming) {
          onTiming(timing);
        }

        return result;
      });
    };

    const start = performance.now();
    let result = executeWithTiming(firstFn, args[0], 0);

    restFns.forEach((fn, index) => {
      result = result.then((value) => executeWithTiming(fn, value, index + 1));
    });

    return result.then((finalResult) => {
      const totalTime = performance.now() - start;

      if (onTiming) {
        onTiming({
          type: "total",
          duration: totalTime,
          individualTimings: timings,
        });
      }

      return finalResult;
    });
  };
}
```

## ç®—æ³•åˆ†æ

- **æ—¶é—´å¤æ‚åº¦**: O(n) - n ä¸ºå‡½æ•°æ•°é‡ï¼Œæ¯ä¸ªå‡½æ•°æ‰§è¡Œä¸€æ¬¡
- **ç©ºé—´å¤æ‚åº¦**: O(1) - åªä½¿ç”¨å¸¸é‡é¢å¤–ç©ºé—´ï¼ˆPromise é“¾ï¼‰
- **ç‰¹ç‚¹**: å¼‚æ­¥å‹å¥½ã€é“¾å¼æ‰§è¡Œã€é”™è¯¯ä¼ æ’­

## å…³é”®æŠ€æœ¯ç‚¹

### 1. Promise.resolve çš„å¦™ç”¨

```javascript
// ç»Ÿä¸€å¤„ç†åŒæ­¥å’Œå¼‚æ­¥è¿”å›å€¼
const result = fn(value);
return Promise.resolve(result); // åŒæ­¥å€¼åŒ…è£…æˆ Promise

// è¿™æ ·åç»­éƒ½å¯ä»¥ä½¿ç”¨ .then() æ–¹æ³•
```

### 2. reduce å®ç°é“¾å¼è°ƒç”¨

```javascript
// æ ¸å¿ƒæ¨¡å¼ï¼šaccumulator æ˜¯ Promiseï¼ŒcurrentValue æ˜¯å‡½æ•°
return fns.reduce(
  (promise, fn) => promise.then(fn),
  Promise.resolve(initialValue),
);
```

### 3. é¦–ä¸ªå‡½æ•°çš„ç‰¹æ®Šå¤„ç†

```javascript
// ç¬¬ä¸€ä¸ªå‡½æ•°å¯ä»¥æ¥æ”¶å¤šä¸ªå‚æ•°
const [firstFn, ...restFns] = fns;
const initialResult = firstFn(...args); // å¤šå‚æ•°

// åç»­å‡½æ•°åªæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼ˆä¸Šä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼‰
restFns.forEach((fn) => (result = result.then(fn)));
```

### 4. é”™è¯¯å¤„ç†å’Œä¼ æ’­

```javascript
// Promise é“¾è‡ªåŠ¨ä¼ æ’­é”™è¯¯
promise.then(fn).catch((error) => {
  // ä»»ä½•ç¯èŠ‚çš„é”™è¯¯éƒ½ä¼šè¢«æ•è·
  console.error("Function composition error:", error);
  throw error; // ç»§ç»­ä¼ æ’­
});
```

### 5. å¸¸è§é™·é˜±å’Œå‘ç‚¹

- **å‚æ•°ä¼ é€’**: ç¬¬ä¸€ä¸ªå‡½æ•°éœ€è¦å¤šå‚æ•°æ”¯æŒ
- **è¿”å›å€¼åŒ…è£…**: åŒæ­¥å‡½æ•°è¿”å›å€¼éœ€è¦ Promise åŒ…è£…
- **ç©ºæ•°ç»„å¤„ç†**: è¾¹ç•Œæƒ…å†µçš„æ’ç­‰å‡½æ•°
- **é”™è¯¯ä¼ æ’­**: ç¡®ä¿å¼‚å¸¸èƒ½æ­£ç¡®ä¼ æ’­
- **æ‰§è¡Œé¡ºåº**: å·¦åˆ°å³ vs å³åˆ°å·¦çš„é€‰æ‹©

## ä½¿ç”¨ç¤ºä¾‹

```javascript
// åŸºæœ¬ç¤ºä¾‹ï¼šæ•°æ®å¤„ç†ç®¡é“
const add = (x) => x + 1;
const multiply = (x) => x * 2;
const square = (x) => x * x;

const pipeline = compose([add, multiply, square]);
pipeline(5).then((result) => {
  console.log(result); // ((5+1)*2)Â² = 144
});

// å¼‚æ­¥å‡½æ•°ç¤ºä¾‹
const fetchUser = (id) => fetch(`/api/users/${id}`).then((r) => r.json());
const getProfile = (user) =>
  fetch(`/api/profiles/${user.id}`).then((r) => r.json());
function formatProfile(profile) {
  return {
    name: profile.name,
    avatar: profile.avatar,
    bio: profile.bio,
  };
}

const getUserProfile = compose([fetchUser, getProfile, formatProfile]);
getUserProfile(123).then((profile) => {
  console.log(profile); // æ ¼å¼åŒ–çš„ç”¨æˆ·æ¡£æ¡ˆ
});

// æ··åˆåŒæ­¥å¼‚æ­¥
function validateInput(input) {
  if (!input) throw new Error("Input required");
  return input.trim();
}

const normalizeText = (text) => text.toLowerCase();

async function saveToDb(text) {
  const response = await fetch("/api/save", {
    method: "POST",
    body: JSON.stringify({ text }),
    headers: { "Content-Type": "application/json" },
  });
  return response.json();
}

const processText = compose([validateInput, normalizeText, saveToDb]);
processText("  Hello World  ")
  .then((result) => {
    console.log("Saved:", result);
  })
  .catch((error) => {
    console.error("Error:", error.message);
  });

// æ•°ç»„å¤„ç†ç®¡é“
const numbers = [1, 2, 3, 4, 5];

const filterEven = (arr) => arr.filter((n) => n % 2 === 0);
const doubleValues = (arr) => arr.map((n) => n * 2);
const sumValues = (arr) => arr.reduce((sum, n) => sum + n, 0);

const processNumbers = compose([filterEven, doubleValues, sumValues]);
processNumbers(numbers).then((result) => {
  console.log(result); // (2+4)*2 = 12
});

// é”™è¯¯å¤„ç†ç¤ºä¾‹
function riskyOperation(x) {
  if (x < 0) throw new Error("Negative input not allowed");
  return x * 2;
}

const safeOperation = (x) => x + 10;

const safePipeline = compose([riskyOperation, safeOperation]);

safePipeline(5).then((result) => {
  console.log("Success:", result); // 20
});

safePipeline(-1).catch((error) => {
  console.error("Error caught:", error.message);
});

// å¤æ‚æ•°æ®è½¬æ¢ç¤ºä¾‹
const rawData = {
  users: [
    { id: 1, name: "Alice", age: 30, status: "active" },
    { id: 2, name: "Bob", age: 25, status: "inactive" },
    { id: 3, name: "Charlie", age: 35, status: "active" },
  ],
};

const extractUsers = (data) => data.users;
const filterActive = (users) =>
  users.filter((user) => user.status === "active");
function addAgeGroup(users) {
  return users.map((user) => ({
    ...user,
    ageGroup: user.age >= 30 ? "senior" : "junior",
  }));
}
const sortByAge = (users) => users.sort((a, b) => a.age - b.age);

const processUserData = compose([
  extractUsers,
  filterActive,
  addAgeGroup,
  sortByAge,
]);

processUserData(rawData).then((result) => {
  console.log("Processed users:", result);
  // [
  //   { id: 1, name: 'Alice', age: 30, status: 'active', ageGroup: 'senior' },
  //   { id: 3, name: 'Charlie', age: 35, status: 'active', ageGroup: 'senior' }
  // ]
});

// ä¸­é—´ä»¶æ¨¡å¼ç¤ºä¾‹
function logger(ctx, next) {
  console.log(`Entering: ${ctx.path}`);
  return next().then(() => {
    console.log(`Exiting: ${ctx.path}`);
  });
}

function auth(ctx, next) {
  if (!ctx.user) {
    throw new Error("Unauthorized");
  }
  return next();
}

function handler(ctx, next) {
  ctx.response = `Hello, ${ctx.user.name}!`;
  return next();
}

const middleware = composeMiddleware([logger, auth, handler]);

const context = {
  path: "/api/hello",
  user: { name: "Alice" },
};

middleware(context).then(() => {
  console.log("Response:", context.response);
});

// æ€§èƒ½ç›‘æ§ç¤ºä¾‹
async function slowOperation(x) {
  await new Promise((resolve) => setTimeout(resolve, 100));
  return x * 2;
}

const fasterOperation = (x) => x + 10;

const monitoredPipeline = composeWithTiming(
  [slowOperation, fasterOperation],
  (timing) => {
    if (timing.type === "total") {
      console.log(`Total execution time: ${timing.duration}ms`);
    } else {
      console.log(`${timing.functionName}: ${timing.duration}ms`);
    }
  },
);

monitoredPipeline(5).then((result) => {
  console.log("Final result:", result);
});

// å‡½æ•°ç»„åˆçš„ç»„åˆï¼ˆé«˜é˜¶ç»„åˆï¼‰
const mathOperations = compose([
  (x) => x + 1, // +1
  (x) => x * 2, // *2
  (x) => x - 3, // -3
]);

const stringOperations = compose([
  (x) => x.toString(), // è½¬å­—ç¬¦ä¸²
  (x) => x.padStart(5, "0"), // è¡¥é›¶
  (x) => `Result: ${x}`, // æ·»åŠ å‰ç¼€
]);

const fullPipeline = compose([mathOperations, stringOperations]);
fullPipeline(10).then((result) => {
  console.log(result); // "Result: 00019"
});
```

## è®°å¿†è¦ç‚¹

### æ ¸å¿ƒè®°å¿†ç‚¹

1. **æ‰§è¡Œé¡ºåº** - ä»å·¦åˆ°å³ï¼Œç¬¦åˆæ•°æ®æµç›´è§‰
2. **PromiseåŒ…è£…** - ç»Ÿä¸€å¤„ç†åŒæ­¥å¼‚æ­¥è¿”å›å€¼
3. **reduceæ¨¡å¼** - ä½¿ç”¨reduceå®ç°é“¾å¼è°ƒç”¨
4. **é¦–å‚ç‰¹æ®Š** - ç¬¬ä¸€ä¸ªå‡½æ•°æ”¯æŒå¤šå‚æ•°
5. **é”™è¯¯ä¼ æ’­** - Promiseé“¾è‡ªåŠ¨å¤„ç†é”™è¯¯ä¼ æ’­

### å®ç°æ¨¡å¼è®°å¿†

```javascript
// æ ‡å‡†æ¨¡å¼
// 1. è¾¹ç•Œæ£€æŸ¥ï¼ˆç©ºæ•°ç»„ã€å•å‡½æ•°ï¼‰
// 2. åˆ†ç¦»é¦–ä¸ªå‡½æ•°ï¼ˆå¤šå‚æ•°æ”¯æŒï¼‰
// 3. reduceé“¾å¼è°ƒç”¨
// 4. PromiseåŒ…è£…ç»Ÿä¸€è¿”å›
```

## æ‰©å±•æ€è€ƒ

### 1. æ”¯æŒåˆ†æ”¯çš„ç»„åˆ

```javascript
function composeBranch(condition, trueBranch, falseBranch) {
  return function (input) {
    return Promise.resolve(condition(input)).then((shouldTakeTrueBranch) => {
      const branch = shouldTakeTrueBranch ? trueBranch : falseBranch;
      return compose(branch)(input);
    });
  };
}

// ä½¿ç”¨ç¤ºä¾‹
const isEven = (x) => x % 2 === 0;
const evenBranch = [(x) => x / 2, (x) => `Even result: ${x}`];
const oddBranch = [(x) => x * 3 + 1, (x) => `Odd result: ${x}`];

const conditionalPipeline = composeBranch(isEven, evenBranch, oddBranch);
```

### 2. æ”¯æŒå¾ªç¯çš„ç»„åˆ

```javascript
function composeLoop(fns, condition, maxIterations = 100) {
  return function (input) {
    const result = Promise.resolve(input);
    let iterations = 0;

    const iterate = (value) => {
      if (iterations >= maxIterations || !condition(value)) {
        return value;
      }

      iterations++;
      return compose(fns)(value).then(iterate);
    };

    return result.then(iterate);
  };
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šè®¡ç®—å¹³æ–¹æ ¹ï¼ˆç‰›é¡¿æ³•ï¼‰
const improve = (x) => (y) => (y + x / y) / 2;
const goodEnough = (x) => (y) => Math.abs(y * y - x) < 0.001;

function sqrt(x) {
  return composeLoop([improve(x)], goodEnough(x))(1.0);
}
```

### 3. æ”¯æŒè®°å¿†åŒ–çš„ç»„åˆ

```javascript
function composeMemoized(fns, keyGenerator = JSON.stringify) {
  const cache = new Map();
  const composedFn = compose(fns);

  return function (...args) {
    const key = keyGenerator(args);

    if (cache.has(key)) {
      return Promise.resolve(cache.get(key));
    }

    return composedFn(...args).then((result) => {
      cache.set(key, result);
      return result;
    });
  };
}
```

### 4. æ”¯æŒå¹¶å‘æ§åˆ¶çš„ç»„åˆ

```javascript
function composeWithConcurrency(fns, concurrency = 2) {
  return function (...args) {
    const queue = [...fns];
    const results = [];
    const running = [];

    const executeNext = () => {
      if (queue.length === 0) {
        return Promise.all(running);
      }

      const fn = queue.shift();
      const promise = Promise.resolve(fn(...args));
      running.push(promise);

      if (running.length >= concurrency) {
        return Promise.race(running).then(() => {
          const index = running.findIndex((p) => p === promise);
          running.splice(index, 1);
          return executeNext();
        });
      }

      return executeNext();
    };

    return executeNext();
  };
}
```

### 5. æ”¯æŒæµå¼å¤„ç†çš„ç»„åˆ

```javascript
function composeStream(fns) {
  return function (inputStream) {
    return fns.reduce((stream, fn) => {
      return stream.pipe(
        new Transform({
          objectMode: true,
          transform(chunk, encoding, callback) {
            try {
              const result = fn(chunk);

              if (result && typeof result.then === "function") {
                result
                  .then((value) => callback(null, value))
                  .catch((error) => callback(error));
              } else {
                callback(null, result);
              }
            } catch (error) {
              callback(error);
            }
          },
        }),
      );
    }, inputStream);
  };
}
```

## å¤ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£å‡½æ•°ç»„åˆçš„æ ¸å¿ƒæ¦‚å¿µå’Œæ‰§è¡Œé¡ºåº
- [ ] æŒæ¡åŒæ­¥å¼‚æ­¥å‡½æ•°çš„ç»Ÿä¸€å¤„ç†æ–¹æ³•
- [ ] ç†Ÿç»ƒä½¿ç”¨ reduce å®ç°é“¾å¼è°ƒç”¨
- [ ] ç†è§£ Promise.resolve çš„ä½œç”¨å’Œç”¨æ³•
- [ ] èƒ½å¤Ÿå¤„ç†è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯ä¼ æ’­
- [ ] äº†è§£ä¸åŒç»„åˆæ¨¡å¼çš„é€‚ç”¨åœºæ™¯
- [ ] æŒæ¡æ€§èƒ½ä¼˜åŒ–å’Œå†…å­˜ç®¡ç†æŠ€å·§
- [ ] ç†Ÿæ‚‰å‡½æ•°å¼ç¼–ç¨‹çš„ç›¸å…³æ¦‚å¿µ
- [ ] èƒ½å¤Ÿæ‰©å±•å’Œå®šåˆ¶ç»„åˆå‡½æ•°çš„åŠŸèƒ½
- [ ] ç†è§£åœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨åœºæ™¯
      return cur.call(this, result)
      })
      },
      Promise.resolve(init.apply(null, args)),
      )
      }
      }

```

## ğŸ§  ç®—æ³•åˆ†æ

### æ ¸å¿ƒæ€è·¯

1. **æå–é¦–ä¸ªå‡½æ•°**ï¼šä½œä¸ºåˆå§‹æ‰§è¡Œå‡½æ•°ï¼Œæ¥æ”¶åŸå§‹å‚æ•°
2. **Promise åŒ…è£…**ï¼šå°†åˆå§‹ç»“æœåŒ…è£…æˆ Promise
3. **reduce é“¾å¼**ï¼šä½¿ç”¨ reduce æ„å»º Promise é“¾
4. **é¡ºåºæ‰§è¡Œ**ï¼šæ¯ä¸ªå‡½æ•°ç­‰å¾…å‰ä¸€ä¸ªå‡½æ•°å®Œæˆåæ‰§è¡Œ

### æ‰§è¡Œæµç¨‹

```

è¾“å…¥å‚æ•° â†’ f(args) â†’ Promise.resolve(result1)
â†’ g(result1) â†’ Promise.resolve(result2)
â†’ h(result2) â†’ æœ€ç»ˆç»“æœ

````

### æ—¶é—´å¤æ‚åº¦

- **O(n)**ï¼šn ä¸ºå‡½æ•°æ•°é‡ï¼Œæ¯ä¸ªå‡½æ•°æ‰§è¡Œä¸€æ¬¡

### ç©ºé—´å¤æ‚åº¦

- **O(n)**ï¼šPromise é“¾çš„è°ƒç”¨æ ˆæ·±åº¦ä¸å‡½æ•°æ•°é‡ç›¸å…³

## ğŸ” å…³é”®æŠ€æœ¯ç‚¹

### 1. å‡½æ•°æ•°ç»„å¤„ç†

```javascript
const init = fns.shift() // æå–ç¬¬ä¸€ä¸ªå‡½æ•°ä½œä¸ºåˆå§‹å‡½æ•°
````

### 2. Promise ç»Ÿä¸€åŒ…è£…

```javascript
Promise.resolve(init.apply(null, args)); // ç»Ÿä¸€å¤„ç†åŒæ­¥/å¼‚æ­¥ç»“æœ
```

### 3. reduce æ„å»ºé“¾å¼è°ƒç”¨

```javascript
fns.reduce((acc, cur) => {
  return acc.then((result) => cur.call(this, result));
}, initialPromise);
```

### 4. this ä¸Šä¸‹æ–‡ä¿æŒ

```javascript
cur.call(this, result); // ä¿æŒå‡½æ•°æ‰§è¡Œæ—¶çš„ this ä¸Šä¸‹æ–‡
```

### 5. é”™è¯¯å¤„ç†æœºåˆ¶

- Promise é“¾è‡ªåŠ¨ä¼ æ’­é”™è¯¯
- ä»»ä½•å‡½æ•°æŠ›å‡ºé”™è¯¯éƒ½ä¼šä¸­æ–­åç»­æ‰§è¡Œ
- æœ€ç»ˆè¿”å› rejected Promise

## ğŸ§ª ä½¿ç”¨ç¤ºä¾‹

### åŒæ­¥å‡½æ•°ç»„åˆ

```javascript
const add = (x) => x + 1;
const multiply = (x) => x * 2;
const square = (x) => x * x;

const composed = compose([add, multiply, square]);
composed(3); // Promise resolving to 64
// æ‰§è¡Œè¿‡ç¨‹ï¼š3 â†’ add(3)=4 â†’ multiply(4)=8 â†’ square(8)=64
```

### å¼‚æ­¥å‡½æ•°ç»„åˆ

```javascript
const fetchUser = (id) => Promise.resolve({ id, name: "John" });
const addAge = (user) => Promise.resolve({ ...user, age: 25 });
const formatUser = (user) => `${user.name} (${user.age})`;

const pipeline = compose([fetchUser, addAge, formatUser]);
pipeline(1).then(console.log); // "John (25)"
```

### æ··åˆåŒæ­¥å¼‚æ­¥

```javascript
const parse = (str) => JSON.parse(str);
async function validate(obj) {
  // å¼‚æ­¥éªŒè¯
  await new Promise((resolve) => setTimeout(resolve, 100));
  return obj.valid ? obj : null;
}
const transform = (obj) => obj?.data || "invalid";

const processor = compose([parse, validate, transform]);
processor('{"valid":true,"data":"success"}');
```

### é”™è¯¯å¤„ç†

```javascript
function throwError() {
  throw new Error("Something wrong");
}
const process = (x) => x * 2;

const errorPipeline = compose([throwError, process]);
errorPipeline(1).catch((err) => console.log(err.message)); // "Something wrong"
```

## ğŸ’¡ å…³é”®è®°å¿†ç‚¹

1. **æ‰§è¡Œé¡ºåº**ï¼šä»å·¦åˆ°å³æ‰§è¡Œï¼ˆä¸æ˜¯ä»å³åˆ°å·¦ï¼‰
2. **Promise åŒ…è£…**ï¼šç»Ÿä¸€å¤„ç†åŒæ­¥å’Œå¼‚æ­¥å‡½æ•°
3. **reduce é“¾å¼**ï¼šæ„å»ºé¡ºåºæ‰§è¡Œçš„ Promise é“¾
4. **é”™è¯¯ä¼ æ’­**ï¼šä»»ä½•ç¯èŠ‚å‡ºé”™éƒ½ä¼šä¸­æ–­åç»­æ‰§è¡Œ
5. **this ä¿æŒ**ï¼šä½¿ç”¨ call ä¿æŒå‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡
6. **shift æå–**ï¼šç¬¬ä¸€ä¸ªå‡½æ•°å•ç‹¬å¤„ç†ï¼Œæ¥æ”¶åŸå§‹å‚æ•°

## ğŸ¤” æ‰©å±•æ€è€ƒ

### pipe vs compose

```javascript
// pipe: ä»å·¦åˆ°å³æ‰§è¡Œï¼Œæ›´ç›´è§‚
const pipe = (fns) => (x) => fns.reduce((acc, fn) => fn(acc), x);

// compose: ä»å³åˆ°å·¦æ‰§è¡Œï¼Œæ•°å­¦åŒ–
const compose = (fns) => (x) => fns.reduceRight((acc, fn) => fn(acc), x);
```

### æ¡†æ¶ä¸­çš„åº”ç”¨

- **Redux**ï¼šä¸­é—´ä»¶çš„ç»„åˆå¤„ç†
- **Koa**ï¼šæ´‹è‘±æ¨¡å‹çš„ä¸­é—´ä»¶æ‰§è¡Œ
- **å‡½æ•°å¼åº“**ï¼šRamdaã€Lodash/FP çš„æ ¸å¿ƒåŠŸèƒ½

### æ€§èƒ½ä¼˜åŒ–

- **æƒ°æ€§æ±‚å€¼**ï¼šåªåœ¨éœ€è¦æ—¶æ‰§è¡Œ
- **ç¼“å­˜ç»“æœ**ï¼šé¿å…é‡å¤è®¡ç®—
- **å¹¶è¡Œä¼˜åŒ–**ï¼šéƒ¨åˆ†ç‹¬ç«‹æ“ä½œå¯ä»¥å¹¶è¡Œ

### é”™è¯¯å¤„ç†å¢å¼º

```javascript
// æ”¯æŒé”™è¯¯æ¢å¤çš„ compose
function safeCompose(fns, errorHandler) {
  return (input) => {
    return fns.reduce(async (acc, fn) => {
      try {
        const result = await acc;
        return await fn(result);
      } catch (error) {
        return errorHandler
          ? errorHandler(error, input)
          : Promise.reject(error);
      }
    }, Promise.resolve(input));
  };
}
```

## ğŸ“ å¤ä¹ è¦ç‚¹

- [ ] ç†è§£å‡½æ•°ç»„åˆçš„æ¦‚å¿µå’Œæ‰§è¡Œé¡ºåº
- [ ] æŒæ¡ reduce åœ¨é“¾å¼è°ƒç”¨ä¸­çš„åº”ç”¨
- [ ] ç†Ÿæ‚‰ Promise å¤„ç†åŒæ­¥å¼‚æ­¥æ··åˆåœºæ™¯
- [ ] ç†è§£ call åœ¨ä¿æŒ this ä¸Šä¸‹æ–‡ä¸­çš„ä½œç”¨
- [ ] èƒ½å¤Ÿå¤„ç†å‡½æ•°ç»„åˆä¸­çš„é”™è¯¯ä¼ æ’­
- [ ] äº†è§£å‡½æ•°ç»„åˆåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨
